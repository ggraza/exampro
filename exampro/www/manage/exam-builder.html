{% extends "exampro/templates/exam_base.html" %}

{% block title %}
{{ _('Exam Builder') }}
{% endblock %}
b‚à´‚à´‚à´‚à´bb
{% block page_content %}
<div class="container">
    <div class="row mb-4">
        <div class="col">
            <h4>üõ†Ô∏è Exam Builder</h4>
            <p class="text-muted">Create or edit exams and schedules in a few simple steps</p>
        </div>
    </div>

    <!-- Steps navigation -->
    <div class="row mb-4">
        <div class="col">
            <div class="steps">
                <ul class="nav nav-pills nav-justified step-navigation mb-3">
                    <li class="nav-item">
                        <a class="nav-link active" id="step1-tab" data-toggle="pill" href="#step1" role="tab">
                            <div class="step-number">1</div>
                            <div class="step-title">Select Exam</div>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="step2-tab" data-toggle="pill" href="#step2" role="tab">
                            <div class="step-number">2</div>
                            <div class="step-title">Add Questions</div>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="step3-tab" data-toggle="pill" href="#step3" role="tab">
                            <div class="step-number">3</div>
                            <div class="step-title">Schedule</div>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="step4-tab" data-toggle="pill" href="#step4" role="tab">
                            <div class="step-number">4</div>
                            <div class="step-title">Registrations</div>
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Form content -->
    <div class="row">
        <div class="col">
            <div class="card mb-10">
                <div class="card-body">
                    <div class="tab-content">
                        <!-- Step 1: Select or Create Exam -->
                        <div class="tab-pane fade show active" id="step1" role="tabpanel">
                            <h5 class="card-title">Step 1: Select or Create Exam</h5>
                            
                            <div class="form-group mb-4">
                                <div class="custom-control custom-radio custom-control-inline">
                                    <input type="radio" id="select-existing-exam" name="exam-choice" class="custom-control-input" value="existing" checked>
                                    <label class="custom-control-label" for="select-existing-exam">Select Existing Exam</label>
                                </div>
                                <div class="custom-control custom-radio custom-control-inline">
                                    <input type="radio" id="create-new-exam" name="exam-choice" class="custom-control-input" value="new">
                                    <label class="custom-control-label" for="create-new-exam">Create New Exam</label>
                                </div>
                            </div>
                            
                            <!-- Select Existing Exam Form -->
                            <div id="existing-exam-form" class="mt-4">
                                <div class="form-group">
                                    <label for="existing-exam">Select Exam</label>
                                    <select id="existing-exam" class="form-control">
                                        <option value="">Select an exam...</option>
                                        {% for exam in exams %}
                                        <option value="{{ exam.name }}">{{ exam.title }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Create New Exam Form -->
                            <div id="new-exam-form" class="mt-4" style="display: none;">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="exam-title">Title <span class="text-danger">*</span></label>
                                            <input type="text" id="exam-title" class="form-control" required>
                                        </div>
                                        
                                        <div class="form-group">
                                            <label for="exam-duration">Duration (minutes) <span class="text-danger">*</span></label>
                                            <input type="number" id="exam-duration" class="form-control" min="1" required>
                                        </div>
                                        
                                        <div class="form-group">
                                            <label for="exam-pass-percentage">Pass Percentage <span class="text-danger">*</span></label>
                                            <input type="number" id="exam-pass-percentage" class="form-control" min="0" max="100" required>
                                        </div>
                                        
                                    </div>
                                </div>
                                
                                <div class="row mt-3">
                                    <div class="col-md-12">
                                        <div class="form-group">
                                            <label for="exam-description">Description <span class="text-danger">*</span></label>
                                            <textarea id="exam-description" class="form-control" rows="3" required></textarea>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row mt-3">
                                    <div class="col-md-12">
                                        <div class="form-group">
                                            <label for="exam-instructions">Instructions</label>
                                            <textarea id="exam-instructions" class="form-control" rows="3"></textarea>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row mt-3">
                                    <div class="col-md-12">
                                        <h6>Examiners</h6>
                                        <table class="table table-sm" id="examiners-table">
                                            <thead>
                                                <tr>
                                                    <th>Examiner</th>
                                                    <th>Can Proctor</th>
                                                    <th>Can Evaluate</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <!-- Rows will be added dynamically -->
                                            </tbody>
                                        </table>
                                        <button type="button" id="add-examiner" class="btn btn-sm btn-outline-primary">
                                            <i class="bi bi-plus"></i> Add Examiner
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Step 2: Add Questions -->
                        <div class="tab-pane fade" id="step2" role="tabpanel">
                            <h5 class="card-title">Step 2: Add Questions to Exam</h5>
                            
                            <!-- Question Selection Type -->
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="question-selection-type">Question order</label>
                                        <select id="question-selection-type" class="form-control">
                                            <option value="Fixed">Same order for all candidates</option>
                                            <option value="Random">Random order for each candidate</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6" id="random-questions-count" style="display: none;">
                                    <div class="form-group">
                                        <label for="total-questions">Total Questions</label>
                                        <input type="number" id="total-questions" class="form-control" min="1">
                                    </div>
                                </div>
                            </div>

                            <!-- Fixed Questions Section -->
                            <div id="fixed-questions-section">
                                <!-- Question Type Filter -->
                                <div class="row mb-4">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="question-type-filter">Question Type Filter</label>
                                            <select id="question-type-filter" class="form-control">
                                                <option value="Mixed">Mixed (Choices + User Input)</option>
                                                <option value="Choices">Choices Only</option>
                                                <option value="User Input">User Input Only</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <!-- Categories Selection -->
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>Available Categories</h6>
                                        <div class="available-categories-container border rounded p-3" style="height: 400px; overflow-y: auto;">
                                            <div id="available-categories">
                                                <!-- Categories will be loaded here -->
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <h6>Selected Categories 
                                            <span class="text-muted" id="selection-summary">
                                                (Total: <span id="total-selected-questions">0</span> questions, 
                                                <span id="total-selected-marks">0</span> marks)
                                            </span>
                                        </h6>
                                        <div class="selected-categories-container border rounded p-3" style="height: 400px; overflow-y: auto;">
                                            <div id="selected-categories">
                                                <!-- Selected categories will appear here -->
                                                <div class="text-center text-muted" id="no-selection-message">
                                                    <p>No categories selected yet</p>
                                                    <small>Select categories from the left panel to add questions</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Step 3: Schedule -->
                        <div class="tab-pane fade" id="step3" role="tabpanel">
                            <h5 class="card-title">Step 3: Exam Schedule</h5>
                            
                            <div class="form-group mb-4">
                                <div class="custom-control custom-radio custom-control-inline">
                                    <input type="radio" id="select-existing-schedule" name="schedule-choice" class="custom-control-input" value="existing">
                                    <label class="custom-control-label" for="select-existing-schedule">Select Existing Schedule</label>
                                </div>
                                <div class="custom-control custom-radio custom-control-inline">
                                    <input type="radio" id="create-new-schedule" name="schedule-choice" class="custom-control-input" value="new" checked>
                                    <label class="custom-control-label" for="create-new-schedule">Create New Schedule</label>
                                </div>
                            </div>
                            
                            <!-- Select Existing Schedule Form -->
                            <div id="existing-schedule-form" class="mt-4" style="display: none;">
                                <div class="form-group">
                                    <label for="existing-schedule">Select Schedule</label>
                                    <select id="existing-schedule" class="form-control">
                                        <!-- Will be dynamically populated based on selected exam -->
                                        <option value="">Select a schedule...</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Create New Schedule Form -->
                            <div id="new-schedule-form" class="mt-4">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="schedule-name">Schedule Name <span class="text-danger">*</span></label>
                                            <input type="text" id="schedule-name" class="form-control" required>
                                        </div>
                                        
                                        <div class="form-group">
                                            <label for="schedule-start-datetime">Start Date & Time <span class="text-danger">*</span></label>
                                            <input type="datetime-local" id="schedule-start-datetime" class="form-control" required>
                                        </div>
                                        
                                        <div class="form-group">
                                            <label for="schedule-type">Schedule Type</label>
                                            <select id="schedule-type" class="form-control">
                                                <option value="One Time">One Time</option>
                                                <option value="Recurring">Recurring</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="schedule-visibility">Visibility</label>
                                            <select id="schedule-visibility" class="form-control">
                                                <option value="Public">Public</option>
                                                <option value="Private">Private</option>
                                                <option value="Archived">Archived</option>
                                            </select>
                                        </div>
                                        
                                        <div class="form-group" id="schedule-expire-days-container">
                                            <label for="schedule-expire-days">Schedule Expire In Days</label>
                                            <input type="number" id="schedule-expire-days" class="form-control" min="1">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Step 4: Manage Registrations -->
                        <div class="tab-pane fade" id="step4" role="tabpanel">
                            <h5 class="card-title">Step 4: Manage Registrations</h5>
                            
                            <div class="row mb-4">
                                <div class="col-md-8">
                                    <div class="form-group">
                                        <label for="registration-email">Add User by Email</label>
                                        <div class="input-group">
                                            <input type="email" id="registration-email" class="form-control" placeholder="user@example.com">
                                            <div class="input-group-append">
                                                <button class="btn btn-primary" type="button" id="add-registration">Add</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="registration-search">Search Registered Users</label>
                                        <input type="text" id="registration-search" class="form-control" placeholder="Search...">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="table-responsive">
                                <table class="table" id="registrations-table">
                                    <thead>
                                        <tr>
                                            <th>User</th>
                                            <th>Email</th>
                                            <th>Registration Date</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Registered users will be listed here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Navigation buttons -->
                    <div class="d-flex justify-content-between mt-4">
                        <button type="button" class="btn btn-secondary" id="prev-step" disabled>Previous</button>
                        <button type="button" class="btn btn-primary" id="next-step">Next</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block style %}
<link rel="stylesheet" href="/assets/exampro/css/exam-builder.css">
<style>
    /* Force override Bootstrap nav pill styling */
    .nav-pills .nav-link.active, 
    .nav-pills .show > .nav-link {
        background-color: transparent !important;
    }
    
    /* Additional specificity to ensure our styles take precedence */
    .step-navigation.nav-pills .nav-link.active,
    body .step-navigation .nav-link.active {
        background-color: transparent !important;
        color: #007bff;
    }

    /* Category selection styles */
    .category-section {
        border-bottom: 1px solid #e9ecef;
        padding-bottom: 1rem;
    }

    .category-title {
        font-weight: 600;
        margin-bottom: 0.5rem;
        border-left: 3px solid #007bff;
        padding-left: 0.5rem;
    }

    .category-item {
        transition: all 0.2s;
        border: 1px solid #e9ecef;
    }

    .category-item:hover {
        border-color: #007bff;
        box-shadow: 0 2px 4px rgba(0,123,255,0.1);
    }

    .selected-category-item {
        border-left: 3px solid #28a745;
    }

    #selection-summary {
        font-size: 0.875rem;
    }

    .available-categories-container,
    .selected-categories-container {
        background-color: #f8f9fa;
    }

    .modal-body p {
        margin-bottom: 0.5rem;
    }

    .badge {
        margin-right: 0.25rem;
    }
</style>
{% endblock %}

{% block script %}
<script>
    frappe.ready(function() {
        // Global variables
        let currentStep = 1;
        let examData = {};
        let scheduleData = {};
        let questionsData = [];
        let registrationsData = [];
        let categoriesData = {};
        let selectedCategoriesData = [];
        
        // Initialize the page
        init();
        
        function init() {
            bindEvents();
            populateDropdowns();
            fetchQuestionCategories();
            
            // Reset all step styles
            $('.nav-link').removeClass('active completed');
            $('#step1-tab').addClass('active');
            
            // Fix any Bootstrap nav-pills styling conflicts
            setTimeout(() => {
                $('.nav-pills .nav-link.active').css('background-color', 'transparent');
            }, 100);
        }
        
        function populateDropdowns() {
            // Populate question type filter
            const questionTypes = ['Mixed', 'Choices', 'User Input'];
            const questionTypeSelect = $('#question-type-filter');
            questionTypeSelect.empty();
            
            questionTypes.forEach(type => {
                questionTypeSelect.append(`<option value="${type}">${type}</option>`);
            });
            
            // Set default to Mixed
            questionTypeSelect.val('Mixed');
            
            // Populate schedule type
            const scheduleTypes = ['Fixed', 'Flexible'];
            const scheduleTypeSelect = $('#schedule-type');
            scheduleTypeSelect.empty();
            
            scheduleTypes.forEach(type => {
                scheduleTypeSelect.append(`<option value="${type}">${type}</option>`);
            });
            
            // Set default to Fixed
            scheduleTypeSelect.val('Fixed');
            
            // Populate visibility
            const visibilityOptions = ['Public', 'Private', 'Archived'];
            const visibilitySelect = $('#schedule-visibility');
            visibilitySelect.empty();
            
            visibilityOptions.forEach(option => {
                visibilitySelect.append(`<option value="${option}">${option}</option>`);
            });
            
            // Set default to Public
            visibilitySelect.val('Public');
        }
        
        function bindEvents() {
            // Exam choice toggle
            $('input[name="exam-choice"]').on('change', function() {
                const choice = $('input[name="exam-choice"]:checked').val();
                if (choice === 'existing') {
                    $('#existing-exam-form').show();
                    $('#new-exam-form').hide();
                } else {
                    $('#existing-exam-form').hide();
                    $('#new-exam-form').show();
                }
            });
            
            // Schedule choice toggle
            $('input[name="schedule-choice"]').on('change', function() {
                const choice = $('input[name="schedule-choice"]:checked').val();
                if (choice === 'existing') {
                    $('#existing-schedule-form').show();
                    $('#new-schedule-form').hide();
                } else {
                    $('#existing-schedule-form').hide();
                    $('#new-schedule-form').show();
                }
            });
            
            // Question selection type change
            $('#question-selection-type').on('change', function() {
                if ($(this).val() === 'Random') {
                    $('#random-questions-count').show();
                    $('#fixed-questions-section').hide();
                } else {
                    $('#random-questions-count').hide();
                    $('#fixed-questions-section').show();
                }
            });

            // Question type filter change
            $('#question-type-filter').on('change', function() {
                renderAvailableCategories();
            });
            
            // Schedule type change
            $('#schedule-type').on('change', function() {
                if ($(this).val() === 'Recurring') {
                    $('#schedule-expire-days-container').show();
                } else {
                    $('#schedule-expire-days-container').hide();
                }
            });
            
            // Existing exam change
            $('#existing-exam').on('change', function() {
                const examId = $(this).val();
                if (examId) {
                    loadExamDetails(examId);
                    loadExamSchedules(examId);
                }
            });
            
            // Existing schedule change
            $('#existing-schedule').on('change', function() {
                const scheduleId = $(this).val();
                if (scheduleId) {
                    loadScheduleDetails(scheduleId);
                    loadRegistrations(scheduleId);
                }
            });
            
            // Add examiner button
            $('#add-examiner').on('click', function() {
                addExaminerRow();
            });
            
            // Add registration button
            $('#add-registration').on('click', function() {
                const email = $('#registration-email').val().trim();
                if (email && validateEmail(email)) {
                    addRegistration(email);
                    $('#registration-email').val('');
                } else {
                    frappe.throw(__('Please enter a valid email address'));
                }
            });
            
            // Search registrations
            $('#registration-search').on('input', function() {
                filterRegistrations($(this).val());
            });
            
            // Navigation buttons
            $('#next-step').on('click', function() {
                if (validateCurrentStep()) {
                    if (currentStep === 2) {
                        // Special handling for step 2 - save exam before proceeding
                        saveExamWithConfirmation();
                    } else if (currentStep < 4) {
                        navigateToStep(currentStep + 1);
                    } else {
                        saveAllData();
                    }
                }
            });
            
            $('#prev-step').on('click', function() {
                if (currentStep > 1) {
                    navigateToStep(currentStep - 1);
                }
            });
            
            // Tab navigation - ensure form validation
            $('.nav-link').on('click', function(e) {
                const targetStep = parseInt($(this).attr('id').replace('step', '').replace('-tab', ''));
                if (targetStep > currentStep) {
                    e.preventDefault();
                    let canProceed = true;
                    for (let i = 1; i < targetStep; i++) {
                        if (!validateStep(i)) {
                            canProceed = false;
                            break;
                        }
                    }
                    if (canProceed) {
                        navigateToStep(targetStep);
                    }
                } else {
                    navigateToStep(targetStep);
                }
            });
        }
        
        function navigateToStep(step) {
            // Update current step
            const previousStep = currentStep;
            currentStep = step;
            
            // Mark completed steps
            if (previousStep < step && validateStep(previousStep)) {
                $(`#step${previousStep}-tab`).addClass('completed');
            }
            
            // Update UI
            $(`.nav-link`).removeClass('active');
            $(`#step${step}-tab`).addClass('active');
            
            $('.tab-pane').removeClass('show active');
            $(`#step${step}`).addClass('show active');
            
            // If navigating to step 2 and we have pending question config, populate it
            if (step === 2 && examData.pendingQuestionConfig) {
                populateStep2FromExam(examData.pendingQuestionConfig);
                delete examData.pendingQuestionConfig; // Remove pending config
            }
            
            // Update button states
            if (step === 1) {
                $('#prev-step').prop('disabled', true);
            } else {
                $('#prev-step').prop('disabled', false);
            }
            
            if (step === 4) {
                $('#next-step').text('Save & Finish');
            } else {
                $('#next-step').text('Next');
            }
        }
        
        function validateCurrentStep() {
            return validateStep(currentStep);
        }
        
        function validateStep(step) {
            switch (step) {
                case 1:
                    // Check if existing exam selected or new exam form filled
                    if ($('input[name="exam-choice"]:checked').val() === 'existing') {
                        if (!$('#existing-exam').val()) {
                            frappe.throw(__('Please select an exam'));
                            return false;
                        }
                    } else {
                        // Check required fields for new exam
                        if (!$('#exam-title').val()) {
                            frappe.throw(__('Exam title is required'));
                            return false;
                        }
                        if (!$('#exam-duration').val() || $('#exam-duration').val() <= 0) {
                            frappe.throw(__('Valid duration is required'));
                            return false;
                        }
                        if (!$('#exam-pass-percentage').val()) {
                            frappe.throw(__('Pass percentage is required'));
                            return false;
                        }
                        if (!$('#exam-description').val()) {
                            frappe.throw(__('Description is required'));
                            return false;
                        }
                    }
                    break;
                    
                case 2:
                    // For fixed questions, check if at least one category selected
                    if ($('#question-selection-type').val() === 'Fixed' && selectedCategoriesData.length === 0) {
                        frappe.throw(__('Please select at least one question category'));
                        return false;
                    }
                    // For random questions, check if count is set
                    if ($('#question-selection-type').val() === 'Random' && (!$('#total-questions').val() || $('#total-questions').val() <= 0)) {
                        frappe.throw(__('Please specify the number of questions'));
                        return false;
                    }
                    break;
                    
                case 3:
                    // Check schedule data
                    if ($('input[name="schedule-choice"]:checked').val() === 'existing') {
                        if (!$('#existing-schedule').val()) {
                            frappe.throw(__('Please select a schedule'));
                            return false;
                        }
                    } else {
                        // Check required fields for new schedule
                        if (!$('#schedule-name').val()) {
                            frappe.throw(__('Schedule name is required'));
                            return false;
                        }
                        if (!$('#schedule-start-datetime').val()) {
                            frappe.throw(__('Start date and time is required'));
                            return false;
                        }
                    }
                    break;
            }
            
            return true;
        }
        
        function loadExamDetails(examId) {
            frappe.call({
                method: 'exampro.www.manage.exam_builder.get_exam_details',
                args: {
                    exam: examId
                },
                callback: function(response) {
                    if (response.message) {
                        examData = response.message;
                        
                        console.log('Loaded exam data:', examData);
                        
                        // Populate step 2 with existing exam's question configuration
                        if (examData.question_config) {
                            // Store the question config for later use
                            examData.pendingQuestionConfig = examData.question_config;
                            
                            // If we're already on step 2 or later, populate immediately
                            if (currentStep >= 2) {
                                populateStep2FromExam(examData.question_config);
                            }
                        }
                        
                        loadExamQuestions(examId);
                    }
                }
            });
        }
        
        function populateStep2FromExam(questionConfig) {
            console.log('Populating step 2 from exam:', questionConfig);
            
            // Set question selection type based on randomize_questions
            if (questionConfig.randomize_questions) {
                $('#question-selection-type').val('Random').trigger('change');
                $('#total-questions').val(questionConfig.total_questions || '');
            } else {
                $('#question-selection-type').val('Fixed').trigger('change');
                
                // Convert select_questions to selectedCategoriesData format
                selectedCategoriesData = [];
                
                if (questionConfig.select_questions && questionConfig.select_questions.length > 0) {
                    // Set question type filter first
                    $('#question-type-filter').val(questionConfig.question_type || 'Mixed');
                    
                    questionConfig.select_questions.forEach(setting => {
                        // For existing exams, we'll use the exam's question_type
                        // If it's Mixed, we'll try to determine the most appropriate type later
                        const questionType = questionConfig.question_type || 'Mixed';
                        
                        selectedCategoriesData.push({
                            category: setting.question_category,
                            type: questionType,
                            mark: setting.mark_per_question,
                            selectedCount: setting.no_of_questions,
                            totalCount: setting.no_of_questions, // Will be updated from available categories
                            fromExistingExam: true // Flag to indicate this came from an existing exam
                        });
                    });
                    
                    console.log('Selected categories data:', selectedCategoriesData);
                    
                    // Render the selected categories immediately
                    renderSelectedCategories();
                    updateSelectionSummary();
                    
                    // If categories data is already loaded, update total counts now
                    if (Object.keys(categoriesData).length > 0) {
                        updateTotalCountsFromAvailableCategories();
                    }
                    // Otherwise, it will be called after fetchQuestionCategories completes
                }
            }
        }
        
        function updateTotalCountsFromAvailableCategories() {
            console.log('Updating total counts from available categories');
            console.log('Selected categories data:', selectedCategoriesData);
            console.log('Available categories data:', categoriesData);
            
            // This function will update the totalCount for selected categories
            // based on the actual available questions in the system
            selectedCategoriesData.forEach(selectedItem => {
                if (categoriesData[selectedItem.category]) {
                    const availableItems = categoriesData[selectedItem.category];
                    
                    // If this is from an existing exam and type is Mixed, find the best match
                    if (selectedItem.fromExistingExam && selectedItem.type === 'Mixed') {
                        // Find the item with the matching mark that has the most questions
                        const matchingItems = availableItems.filter(item => item.mark === selectedItem.mark);
                        if (matchingItems.length > 0) {
                            // Sort by question count descending and take the first one
                            matchingItems.sort((a, b) => b.question_count - a.question_count);
                            const bestMatch = matchingItems[0];
                            selectedItem.type = bestMatch.type;
                            selectedItem.totalCount = bestMatch.question_count;
                            console.log(`Updated ${selectedItem.category} from Mixed to ${bestMatch.type}`);
                        }
                    } else {
                        // Normal case - exact match
                        const matchingItem = availableItems.find(item => 
                            item.type === selectedItem.type && item.mark === selectedItem.mark
                        );
                        if (matchingItem) {
                            selectedItem.totalCount = matchingItem.question_count;
                            console.log(`Updated ${selectedItem.category} total count to ${matchingItem.question_count}`);
                        } else {
                            console.log(`No matching item found for ${selectedItem.category} with type ${selectedItem.type} and mark ${selectedItem.mark}`);
                        }
                    }
                } else {
                    console.log(`Category ${selectedItem.category} not found in available categories`);
                }
            });
            
            console.log('Updated selected categories data:', selectedCategoriesData);
            
            // Re-render to show updated information
            renderSelectedCategories();
            updateSelectionSummary();
        }
        
        function loadExamQuestions(examId) {
            frappe.call({
                method: 'exampro.www.manage.exam_builder.get_exam_questions',
                args: {
                    exam: examId
                },
                callback: function(response) {
                    if (response.message) {
                        questionsData = response.message;
                        
                        // Populate selected questions
                        $('#selected-questions').empty();
                        questionsData.forEach(q => {
                            const listItem = `<li class="list-group-item d-flex justify-content-between align-items-center" data-id="${q.exam_question}">
                                ${q.question_text} 
                                <span class="badge badge-primary badge-pill">Mark: ${q.mark}</span>
                                <button class="btn btn-sm btn-danger remove-question"><i class="bi bi-x"></i></button>
                            </li>`;
                            $('#selected-questions').append(listItem);
                        });
                        
                        // Bind remove events
                        $('.remove-question').on('click', function() {
                            $(this).closest('li').remove();
                        });
                    }
                }
            });
        }
        
        function loadExamSchedules(examId) {
            frappe.call({
                method: 'exampro.www.manage.exam_builder.get_exam_schedules',
                args: {
                    exam: examId
                },
                callback: function(response) {
                    if (response.message) {
                        // Populate schedules dropdown
                        const schedules = response.message;
                        $('#existing-schedule').empty();
                        $('#existing-schedule').append('<option value="">Select a schedule...</option>');
                        
                        schedules.forEach(s => {
                            $('#existing-schedule').append(`<option value="${s.name}">${s.schedule_name} (${s.start_date_time})</option>`);
                        });
                    }
                }
            });
        }
        
        function loadScheduleDetails(scheduleId) {
            frappe.call({
                method: 'exampro.www.manage.exam_builder.get_schedule_details',
                args: {
                    schedule: scheduleId
                },
                callback: function(response) {
                    if (response.message) {
                        scheduleData = response.message;
                    }
                }
            });
        }
        
        function loadRegistrations(scheduleId) {
            frappe.call({
                method: 'exampro.www.manage.exam_builder.get_registrations',
                args: {
                    schedule: scheduleId
                },
                callback: function(response) {
                    if (response.message) {
                        registrationsData = response.message;
                        renderRegistrationsTable();
                    }
                }
            });
        }
        
        function fetchQuestionCategories() {
            console.log('Fetching question categories...');
            frappe.call({
                method: 'exampro.www.manage.exam_builder.get_question_categories_with_counts',
                callback: function(response) {
                    if (response.message) {
                        categoriesData = response.message;
                        console.log('Fetched categories data:', categoriesData);
                        renderAvailableCategories();
                        
                        // If we have selected categories from an existing exam, update their total counts
                        if (selectedCategoriesData.length > 0) {
                            console.log('Updating total counts for existing selected categories');
                            updateTotalCountsFromAvailableCategories();
                        }
                    }
                }
            });
        }

        function renderAvailableCategories() {
            const container = $('#available-categories');
            container.empty();
            
            const typeFilter = $('#question-type-filter').val();
            
            Object.keys(categoriesData).forEach(categoryName => {
                const categoryItems = categoriesData[categoryName];
                
                // Filter by question type if not "Mixed"
                const filteredItems = typeFilter === 'Mixed' 
                    ? categoryItems 
                    : categoryItems.filter(item => item.type === typeFilter);
                
                if (filteredItems.length === 0) return;
                
                // Create category section
                const categoryDiv = $(`
                    <div class="category-section mb-3">
                        <h6 class="category-title text-primary">${categoryName}</h6>
                        <div class="category-items"></div>
                    </div>
                `);
                
                const itemsContainer = categoryDiv.find('.category-items');
                
                filteredItems.forEach(item => {
                    const itemDiv = $(`
                        <div class="category-item card mb-2" style="cursor: pointer;">
                            <div class="card-body p-2">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <small class="text-muted">${item.type}</small>
                                        <div><strong>${item.question_count} questions</strong> √ó ${item.mark} mark(s)</div>
                                    </div>
                                    <button class="btn btn-sm btn-outline-primary add-category-btn" 
                                            data-category="${categoryName}"
                                            data-type="${item.type}"
                                            data-mark="${item.mark}"
                                            data-count="${item.question_count}">
                                        <i class="bi bi-plus"></i> Add
                                    </button>
                                </div>
                            </div>
                        </div>
                    `);
                    
                    itemsContainer.append(itemDiv);
                });
                
                container.append(categoryDiv);
            });
            
            // Bind add category events
            $('.add-category-btn').on('click', function(e) {
                e.stopPropagation();
                const category = $(this).data('category');
                const type = $(this).data('type');
                const mark = $(this).data('mark');
                const count = $(this).data('count');
                
                showQuestionSelectionModal(category, type, mark, count);
            });
        }

        function showQuestionSelectionModal(category, type, mark, totalCount) {
            const modalHtml = `
                <div class="modal fade" id="questionSelectionModal" tabindex="-1" role="dialog">
                    <div class="modal-dialog modal-lg" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Select Questions</h5>
                                <button type="button" class="close" data-dismiss="modal">
                                    <span>&times;</span>
                                </button>
                            </div>
                            <div class="modal-body">
                                <p><strong>Category:</strong> ${category}</p>
                                <p><strong>Type:</strong> ${type}</p>
                                <p><strong>Mark per question:</strong> ${mark}</p>
                                <p><strong>Available questions:</strong> ${totalCount}</p>
                                
                                <!-- View Questions Section -->
                                <div class="mb-4">
                                    <h6>View Questions</h6>
                                    <div class="border rounded" style="height: 300px; overflow-y: auto;">
                                        <table class="table table-sm table-striped mb-0" id="questions-preview-table">
                                            <thead class="thead-light sticky-top">
                                                <tr>
                                                    <th style="width: 60px;">#</th>
                                                    <th>Question</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td colspan="2" class="text-center">
                                                        <div class="spinner-border spinner-border-sm" role="status">
                                                            <span class="sr-only">Loading...</span>
                                                        </div>
                                                        Loading questions...
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="question-count-input">Number of questions to select:</label>
                                    <input type="number" id="question-count-input" class="form-control" 
                                           min="1" max="${totalCount}" value="${totalCount}">
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" id="confirm-selection">Add Selected</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if any
            $('#questionSelectionModal').remove();
            
            // Add modal to body
            $('body').append(modalHtml);
            
            // Show modal
            $('#questionSelectionModal').modal('show');
            
            // Load questions preview
            loadQuestionsPreview(category, type, mark);
            
            // Bind confirm button
            $('#confirm-selection').on('click', function() {
                const selectedCount = parseInt($('#question-count-input').val());
                if (selectedCount > 0 && selectedCount <= totalCount) {
                    addSelectedCategory(category, type, mark, selectedCount, totalCount);
                    $('#questionSelectionModal').modal('hide');
                } else {
                    frappe.throw(__('Please enter a valid number of questions'));
                }
            });
        }

        function loadQuestionsPreview(category, type, mark) {
            frappe.call({
                method: 'exampro.www.manage.exam_builder.get_questions_preview',
                args: {
                    category: category,
                    question_type: type,
                    mark: mark
                },
                callback: function(response) {
                    const tbody = $('#questions-preview-table tbody');
                    tbody.empty();
                    
                    if (response.message && response.message.length > 0) {
                        response.message.forEach((question, index) => {
                            const row = `
                                <tr>
                                    <td>${index + 1}</td>
                                    <td class="text-truncate" style="max-width: 400px;" title="${question.question}">
                                        ${question.question}
                                    </td>
                                </tr>
                            `;
                            tbody.append(row);
                        });
                    } else {
                        tbody.append(`
                            <tr>
                                <td colspan="2" class="text-center text-muted">
                                    No questions found
                                </td>
                            </tr>
                        `);
                    }
                },
                error: function() {
                    $('#questions-preview-table tbody').html(`
                        <tr>
                            <td colspan="2" class="text-center text-danger">
                                Error loading questions
                            </td>
                        </tr>
                    `);
                }
            });
        }

        function addSelectedCategory(category, type, mark, selectedCount, totalCount) {
            // Check if this exact combination already exists
            const existingIndex = selectedCategoriesData.findIndex(item => 
                item.category === category && item.type === type && item.mark === mark
            );
            
            if (existingIndex >= 0) {
                frappe.throw(__('This category/type/mark combination is already selected'));
                return;
            }
            
            // Add to selected data
            selectedCategoriesData.push({
                category: category,
                type: type,
                mark: mark,
                selectedCount: selectedCount,
                totalCount: totalCount
            });
            
            renderSelectedCategories();
            updateSelectionSummary();
        }

        function renderSelectedCategories() {
            const container = $('#selected-categories');
            container.empty();
            
            if (selectedCategoriesData.length === 0) {
                container.html(`
                    <div class="text-center text-muted" id="no-selection-message">
                        <p>No categories selected yet</p>
                        <small>Select categories from the left panel to add questions</small>
                    </div>
                `);
                return;
            }
            
            selectedCategoriesData.forEach((item, index) => {
                const itemDiv = $(`
                    <div class="selected-category-item card mb-2">
                        <div class="card-body p-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>${item.category}</strong>
                                    <br>
                                    <small class="text-muted">${item.type} ‚Ä¢ ${item.mark} mark(s) each</small>
                                    <br>
                                    <span class="badge badge-primary">${item.selectedCount} of ${item.totalCount} questions</span>
                                    <span class="badge badge-success">${item.selectedCount * item.mark} marks</span>
                                </div>
                                <div>
                                    <button class="btn btn-sm btn-outline-secondary edit-selection-btn mr-1" 
                                            data-index="${index}">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger remove-selection-btn" 
                                            data-index="${index}">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `);
                
                container.append(itemDiv);
            });
            
            // Bind edit and remove events
            $('.edit-selection-btn').on('click', function() {
                const index = $(this).data('index');
                const item = selectedCategoriesData[index];
                editSelectedCategory(index, item);
            });
            
            $('.remove-selection-btn').on('click', function() {
                const index = $(this).data('index');
                removeSelectedCategory(index);
            });
        }

        function editSelectedCategory(index, item) {
            const modalHtml = `
                <div class="modal fade" id="editSelectionModal" tabindex="-1" role="dialog">
                    <div class="modal-dialog" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Edit Selection</h5>
                                <button type="button" class="close" data-dismiss="modal">
                                    <span>&times;</span>
                                </button>
                            </div>
                            <div class="modal-body">
                                <p><strong>Category:</strong> ${item.category}</p>
                                <p><strong>Type:</strong> ${item.type}</p>
                                <p><strong>Mark per question:</strong> ${item.mark}</p>
                                <p><strong>Available questions:</strong> ${item.totalCount}</p>
                                
                                <div class="form-group">
                                    <label for="edit-question-count">Number of questions:</label>
                                    <input type="number" id="edit-question-count" class="form-control" 
                                           min="1" max="${item.totalCount}" value="${item.selectedCount}">
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" id="confirm-edit">Update</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if any
            $('#editSelectionModal').remove();
            
            // Add modal to body
            $('body').append(modalHtml);
            
            // Show modal
            $('#editSelectionModal').modal('show');
            
            // Bind confirm button
            $('#confirm-edit').on('click', function() {
                const newCount = parseInt($('#edit-question-count').val());
                if (newCount > 0 && newCount <= item.totalCount) {
                    selectedCategoriesData[index].selectedCount = newCount;
                    renderSelectedCategories();
                    updateSelectionSummary();
                    $('#editSelectionModal').modal('hide');
                } else {
                    frappe.throw(__('Please enter a valid number of questions'));
                }
            });
        }

        function removeSelectedCategory(index) {
            selectedCategoriesData.splice(index, 1);
            renderSelectedCategories();
            updateSelectionSummary();
        }

        function updateSelectionSummary() {
            let totalQuestions = 0;
            let totalMarks = 0;
            
            selectedCategoriesData.forEach(item => {
                totalQuestions += item.selectedCount;
                totalMarks += item.selectedCount * item.mark;
            });
            
            $('#total-selected-questions').text(totalQuestions);
            $('#total-selected-marks').text(totalMarks);
        }
        
        function addExaminerRow() {
            const rowIndex = $('#examiners-table tbody tr').length;
            const newRow = `<tr>
                <td>
                    <select class="form-control form-control-sm examiner-user" name="examiners[${rowIndex}][examiner]" required>
                        <option value="">Select User...</option>
                    </select>
                </td>
                <td>
                    <div class="custom-control custom-checkbox">
                        <input type="checkbox" class="custom-control-input" id="can-proctor-${rowIndex}" name="examiners[${rowIndex}][can_proctor]" checked>
                        <label class="custom-control-label" for="can-proctor-${rowIndex}"></label>
                    </div>
                </td>
                <td>
                    <div class="custom-control custom-checkbox">
                        <input type="checkbox" class="custom-control-input" id="can-evaluate-${rowIndex}" name="examiners[${rowIndex}][can_evaluate]" checked>
                        <label class="custom-control-label" for="can-evaluate-${rowIndex}"></label>
                    </div>
                </td>
                <td>
                    <button type="button" class="btn btn-sm btn-danger remove-examiner">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            </tr>`;
            
            $('#examiners-table tbody').append(newRow);
            
            // Load users for the dropdown
            loadUserOptions(rowIndex);
            
            // Bind remove button
            $('.remove-examiner').off('click').on('click', function() {
                $(this).closest('tr').remove();
            });
        }
        
        function loadUserOptions(rowIndex) {
            frappe.call({
                method: 'exampro.www.manage.exam_builder.get_users',
                callback: function(response) {
                    if (response.message) {
                        const userSelect = $(`select[name="examiners[${rowIndex}][examiner]"]`);
                        response.message.forEach(user => {
                            userSelect.append(`<option value="${user.name}">${user.full_name} (${user.name})</option>`);
                        });
                    }
                }
            });
        }
        
        function addRegistration(email) {
            frappe.call({
                method: 'exampro.www.manage.exam_builder.add_registration',
                args: {
                    schedule: scheduleData.name,
                    email: email
                },
                callback: function(response) {
                    if (response.message && response.message.success) {
                        registrationsData.push(response.message.user);
                        renderRegistrationsTable();
                        frappe.show_alert({
                            message: __('User added successfully'),
                            indicator: 'green'
                        });
                    } else {
                        frappe.throw(response.message.error || __('Failed to add user'));
                    }
                }
            });
        }
        
        function renderRegistrationsTable() {
            $('#registrations-table tbody').empty();
            
            if (registrationsData.length === 0) {
                $('#registrations-table tbody').append(`
                    <tr>
                        <td colspan="5" class="text-center">No registrations found</td>
                    </tr>
                `);
                return;
            }
            
            registrationsData.forEach(r => {
                const row = `<tr>
                    <td>${r.user_name || r.user}</td>
                    <td>${r.email}</td>
                    <td>${r.creation}</td>
                    <td><span class="badge badge-${r.status === 'Registered' ? 'success' : 'secondary'}">${r.status}</span></td>
                    <td>
                        <button class="btn btn-sm btn-danger remove-registration" data-user="${r.user}">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>`;
                
                $('#registrations-table tbody').append(row);
            });
            
            // Bind remove buttons
            $('.remove-registration').off('click').on('click', function() {
                const user = $(this).data('user');
                removeRegistration(user);
            });
        }
        
        function removeRegistration(user) {
            frappe.confirm(
                __('Are you sure you want to remove this user from the exam?'),
                function() {
                    frappe.call({
                        method: 'exampro.www.manage.exam_builder.remove_registration',
                        args: {
                            schedule: scheduleData.name,
                            user: user
                        },
                        callback: function(response) {
                            if (response.message && response.message.success) {
                                registrationsData = registrationsData.filter(r => r.user !== user);
                                renderRegistrationsTable();
                                frappe.show_alert({
                                    message: __('User removed successfully'),
                                    indicator: 'green'
                                });
                            } else {
                                frappe.throw(response.message.error || __('Failed to remove user'));
                            }
                        }
                    });
                }
            );
        }
        
        function filterRegistrations(query) {
            if (!query) {
                $('#registrations-table tbody tr').show();
                return;
            }
            
            query = query.toLowerCase();
            $('#registrations-table tbody tr').each(function() {
                const text = $(this).text().toLowerCase();
                if (text.includes(query)) {
                    $(this).show();
                } else {
                    $(this).hide();
                }
            });
        }
        
        function saveAllData() {
            // Collect all data
            const formData = {
                exam: collectExamData(),
                questions: collectQuestionsData(),
                schedule: collectScheduleData()
            };
            
            frappe.call({
                method: 'exampro.www.manage.exam_builder.save_exam_builder_data',
                args: {
                    data: formData
                },
                callback: function(response) {
                    if (response.message && response.message.success) {
                        frappe.show_alert({
                            message: __('Exam and schedule saved successfully'),
                            indicator: 'green'
                        });
                        
                        setTimeout(function() {
                            window.location.href = '/manage/exams';
                        }, 1000);
                    } else {
                        frappe.throw(response.message.error || __('Failed to save data'));
                    }
                }
            });
        }
        
        function collectExamData() {
            if ($('input[name="exam-choice"]:checked').val() === 'existing') {
                return {
                    type: 'existing',
                    name: $('#existing-exam').val()
                };
            } else {
                const examiners = [];
                $('#examiners-table tbody tr').each(function() {
                    const rowIndex = $(this).index();
                    const examiner = {
                        examiner: $(`select[name="examiners[${rowIndex}][examiner]"]`).val(),
                        can_proctor: $(`#can-proctor-${rowIndex}`).is(':checked'),
                        can_evaluate: $(`#can-evaluate-${rowIndex}`).is(':checked')
                    };
                    
                    if (examiner.examiner) {
                        examiners.push(examiner);
                    }
                });
                
                return {
                    type: 'new',
                    title: $('#exam-title').val(),
                    duration: $('#exam-duration').val(),
                    pass_percentage: $('#exam-pass-percentage').val(),
                    image: $('#exam-image').val(), // Note: File handling will be different
                    description: $('#exam-description').val(),
                    instructions: $('#exam-instructions').val(),
                    examiners: examiners
                };
            }
        }
        
        function collectQuestionsData() {
            const questionSelectionType = $('#question-selection-type').val();
            
            if (questionSelectionType === 'Random') {
                return {
                    type: 'Random',
                    total_questions: $('#total-questions').val()
                };
            } else {
                // For Fixed questions, return category-based selection
                return {
                    type: 'Fixed',
                    question_type_filter: $('#question-type-filter').val(),
                    categories: selectedCategoriesData
                };
            }
        }
        
        function collectScheduleData() {
            if ($('input[name="schedule-choice"]:checked').val() === 'existing') {
                return {
                    type: 'existing',
                    name: $('#existing-schedule').val()
                };
            } else {
                return {
                    type: 'new',
                    name: $('#schedule-name').val(),
                    start_date_time: $('#schedule-start-datetime').val(),
                    schedule_type: $('#schedule-type').val(),
                    schedule_expire_in_days: $('#schedule-expire-days').val(),
                    visibility: $('#schedule-visibility').val()
                };
            }
        }
        
        function validateEmail(email) {
            const re = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
            return re.test(String(email).toLowerCase());
        }
        
        function saveExamWithConfirmation() {
            const isExistingExam = $('input[name="exam-choice"]:checked').val() === 'existing';
            const examTitle = isExistingExam ? 
                $('#existing-exam option:selected').text() : 
                $('#exam-title').val();
            
            const action = isExistingExam ? 'update' : 'create';
            const message = isExistingExam ? 
                `Are you sure you want to update the exam "${examTitle}" with the current question configuration?` :
                `Are you sure you want to create the exam "${examTitle}" with the current configuration?`;
            
            frappe.confirm(
                __(message),
                function() {
                    // User confirmed, proceed with saving
                    saveExamData().then(() => {
                        navigateToStep(3);
                    }).catch((error) => {
                        frappe.throw(error.message || 'Failed to save exam');
                    });
                },
                function() {
                    // User cancelled, do nothing
                }
            );
        }
        
        function saveExamData() {
            return new Promise((resolve, reject) => {
                // Collect exam and questions data
                const formExamData = collectExamData();
                const questionsData = collectQuestionsData();
                
                const formData = {
                    ...formExamData,
                    questions: questionsData
                };
                
                frappe.call({
                    method: 'exampro.www.manage.exam_builder.save_exam_from_builder',
                    args: {
                        exam_data: formData
                    },
                    callback: function(response) {
                        if (response.message && response.message.success) {
                            frappe.show_alert({
                                message: __(response.message.message),
                                indicator: 'green'
                            });
                            
                            // Update global examData with the saved exam name for future operations
                            if (formExamData.type === 'new') {
                                // Update global examData to reflect that this is now an existing exam
                                examData.name = response.message.exam_name;
                                
                                // Update the existing exam dropdown and select the new exam
                                updateExistingExamDropdown(response.message.exam_name);
                            }
                            
                            resolve(response.message);
                        } else {
                            reject(new Error(response.message?.error || 'Failed to save exam'));
                        }
                    },
                    error: function(error) {
                        reject(error);
                    }
                });
            });
        }
        
        function updateExistingExamDropdown(examName) {
            // Refresh the existing exam dropdown to include the newly created exam
            frappe.call({
                method: 'exampro.www.manage.exam_builder.get_exams',
                callback: function(response) {
                    if (response.message) {
                        const existingExamSelect = $('#existing-exam');
                        existingExamSelect.empty();
                        existingExamSelect.append('<option value="">Select an exam...</option>');
                        
                        response.message.forEach(exam => {
                            const selected = exam.name === examName ? 'selected' : '';
                            existingExamSelect.append(`<option value="${exam.name}" ${selected}>${exam.title}</option>`);
                        });
                        
                        // Switch to existing exam mode
                        $('input[name="exam-choice"][value="existing"]').prop('checked', true).trigger('change');
                    }
                }
            });
        }
    });
</script>
{% endblock %}
