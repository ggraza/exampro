{% extends "exampro/templates/exam_base.html" %}

{% block title %}
{{ _('Exam Builder') }}
{% endblock %}
{% block page_content %}
<div class="container">
    <div class="row mb-4">
        <div class="col">
            <h4>üõ†Ô∏è Exam Builder</h4>
            <p class="text-muted">Create or edit exams and schedules in a few simple steps</p>
        </div>
    </div>

    <!-- Steps navigation -->
    <div class="row mb-4">
        <div class="col">
            <div class="steps">
                <ul class="nav nav-pills nav-justified step-navigation mb-3">
                    <li class="nav-item">
                        <a class="nav-link active" id="step1-tab" data-toggle="pill" href="#step1" role="tab">
                            <div class="step-number">1</div>
                            <div class="step-title">Select Exam</div>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="step2-tab" data-toggle="pill" href="#step2" role="tab">
                            <div class="step-number">2</div>
                            <div class="step-title">Add Questions</div>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="step3-tab" data-toggle="pill" href="#step3" role="tab">
                            <div class="step-number">3</div>
                            <div class="step-title">Schedule</div>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="step4-tab" data-toggle="pill" href="#step4" role="tab">
                            <div class="step-number">4</div>
                            <div class="step-title">Registrations</div>
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Form content -->
    <div class="row">
        <div class="col">
            <div class="card mb-10">
                <div class="card-body">
                    <div class="tab-content">
                        <!-- Step 1: Select or Create Exam -->
                        <div class="tab-pane fade show active" id="step1" role="tabpanel">
                            <h5 class="card-title">Step 1: Select or Create Exam</h5>
                            
                            <div class="form-group mb-4">
                                <div class="custom-control custom-radio custom-control-inline">
                                    <input type="radio" id="select-existing-exam" name="exam-choice" class="custom-control-input" value="existing" checked>
                                    <label class="custom-control-label" for="select-existing-exam">Select Existing Exam</label>
                                </div>
                                <div class="custom-control custom-radio custom-control-inline">
                                    <input type="radio" id="create-new-exam" name="exam-choice" class="custom-control-input" value="new">
                                    <label class="custom-control-label" for="create-new-exam">Create New Exam</label>
                                </div>
                            </div>
                            
                            <!-- Select Existing Exam Form -->
                            <div id="existing-exam-form" class="mt-4">
                                <div class="form-group">
                                    <label for="existing-exam">Select Exam</label>
                                    <select id="existing-exam" class="form-control">
                                        <option value="">Select an exam...</option>
                                        {% for exam in exams %}
                                        <option value="{{ exam.name }}">{{ exam.title }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Create New Exam Form -->
                            <div id="new-exam-form" class="mt-4" style="display: none;">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="exam-title">Title <span class="text-danger">*</span></label>
                                            <input type="text" id="exam-title" class="form-control" required>
                                        </div>
                                        
                                        <div class="form-group">
                                            <label for="exam-duration">Duration (minutes) <span class="text-danger">*</span></label>
                                            <input type="number" id="exam-duration" class="form-control" min="1" required>
                                        </div>
                                        
                                        <div class="form-group">
                                            <label for="exam-pass-percentage">Pass Percentage <span class="text-danger">*</span></label>
                                            <input type="number" id="exam-pass-percentage" class="form-control" min="0" max="100" required>
                                        </div>
                                        
                                    </div>
                                </div>
                                
                                <div class="row mt-3">
                                    <div class="col-md-12">
                                        <div class="form-group">
                                            <label for="exam-description">Description <span class="text-danger">*</span></label>
                                            <textarea id="exam-description" class="form-control" rows="3" required></textarea>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row mt-3">
                                    <div class="col-md-12">
                                        <div class="form-group">
                                            <label for="exam-instructions">Instructions</label>
                                            <textarea id="exam-instructions" class="form-control" rows="3"></textarea>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row mt-3">
                                    <div class="col-md-12">
                                        <h6>Examiners</h6>
                                        <table class="table table-sm" id="examiners-table">
                                            <thead>
                                                <tr>
                                                    <th>Examiner</th>
                                                    <th>Can Proctor</th>
                                                    <th>Can Evaluate</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <!-- Rows will be added dynamically -->
                                            </tbody>
                                        </table>
                                        <button type="button" id="add-examiner" class="btn btn-sm btn-outline-primary">
                                            <i class="bi bi-plus"></i> Add Examiner
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Step 2: Add Questions -->
                        <div class="tab-pane fade" id="step2" role="tabpanel">
                            <h5 class="card-title">Step 2: Add Questions to Exam</h5>
                            
                            <!-- Question Selection Type -->
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="question-selection-type">Question order</label>
                                        <select id="question-selection-type" class="form-control">
                                            <option value="Fixed">Same order for all candidates</option>
                                            <option value="Random">Random order for each candidate</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6" id="random-questions-count" style="display: none;">
                                    <div class="form-group">
                                        <label for="total-questions">Total Questions</label>
                                        <input type="number" id="total-questions" class="form-control" min="1">
                                    </div>
                                </div>
                            </div>

                            <!-- Fixed Questions Section -->
                            <div id="fixed-questions-section">
                                <!-- Question Type Filter -->
                                <div class="row mb-4">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="question-type-filter">Question Type Filter</label>
                                            <select id="question-type-filter" class="form-control">
                                                <option value="Mixed">Mixed (Choices + User Input)</option>
                                                <option value="Choices">Choices Only</option>
                                                <option value="User Input">User Input Only</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <!-- Categories Selection -->
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>Available Categories</h6>
                                        <div class="available-categories-container border rounded p-3" style="height: 400px; overflow-y: auto;">
                                            <div id="available-categories">
                                                <!-- Categories will be loaded here -->
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <h6>Selected Categories 
                                            <span class="text-muted" id="selection-summary">
                                                (Total: <span id="total-selected-questions">0</span> questions, 
                                                <span id="total-selected-marks">0</span> marks)
                                            </span>
                                        </h6>
                                        <div class="selected-categories-container border rounded p-3" style="height: 400px; overflow-y: auto;">
                                            <div id="selected-categories">
                                                <!-- Selected categories will appear here -->
                                                <div class="text-center text-muted" id="no-selection-message">
                                                    <p>No categories selected yet</p>
                                                    <small>Select categories from the left panel to add questions</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Step 3: Schedule -->
                        <div class="tab-pane fade" id="step3" role="tabpanel">
                            <h5 class="card-title">Step 3: Exam Schedule</h5>
                            
                            <div class="form-group mb-4">
                                <div class="custom-control custom-radio custom-control-inline">
                                    <input type="radio" id="select-existing-schedule" name="schedule-choice" class="custom-control-input" value="existing">
                                    <label class="custom-control-label" for="select-existing-schedule">Select Existing Schedule</label>
                                </div>
                                <div class="custom-control custom-radio custom-control-inline">
                                    <input type="radio" id="create-new-schedule" name="schedule-choice" class="custom-control-input" value="new" checked>
                                    <label class="custom-control-label" for="create-new-schedule">Create New Schedule</label>
                                </div>
                            </div>
                            
                            <!-- Select Existing Schedule Form -->
                            <div id="existing-schedule-form" class="mt-4" style="display: none;">
                                <div class="form-group">
                                    <label for="existing-schedule">Select Schedule</label>
                                    <select id="existing-schedule" class="form-control">
                                        <!-- Will be dynamically populated based on selected exam -->
                                        <option value="">Select a schedule...</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Create New Schedule Form -->
                            <div id="new-schedule-form" class="mt-4">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="schedule-name">Schedule Name <span class="text-danger">*</span></label>
                                            <input type="text" id="schedule-name" class="form-control" required>
                                        </div>
                                        
                                        <div class="form-group">
                                            <label for="schedule-start-datetime">Start Date & Time <span class="text-danger">*</span></label>
                                            <input type="datetime-local" id="schedule-start-datetime" class="form-control" required>
                                        </div>
                                        
                                        <div class="form-group">
                                            <label for="schedule-type">Schedule Type</label>
                                            <select id="schedule-type" class="form-control">
                                                <option value="One Time">One Time</option>
                                                <option value="Recurring">Recurring</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="schedule-visibility">Visibility</label>
                                            <select id="schedule-visibility" class="form-control">
                                                <option value="Public">Public</option>
                                                <option value="Private">Private</option>
                                                <option value="Archived">Archived</option>
                                            </select>
                                        </div>
                                        
                                        <div class="form-group" id="schedule-expire-days-container">
                                            <label for="schedule-expire-days">Schedule Expire In Days</label>
                                            <input type="number" id="schedule-expire-days" class="form-control" min="1">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Step 4: Manage Registrations -->
                        <div class="tab-pane fade" id="step4" role="tabpanel">
                            <h5 class="card-title">Step 4: Manage Registrations</h5>
                            
                            <!-- Manage all users link -->
                            <div class="d-flex justify-content-end mb-3">
                                <a href="/manage/users" class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-people"></i> Manage all users
                                </a>
                            </div>
                            
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <div class="card h-100">
                                        <div class="card-header">
                                            <h6 class="mb-0">Available Users (Exam Candidates)</h6>
                                        </div>
                                        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                            <table class="table table-sm table-hover" id="available-users-table">
                                                <thead class="sticky-top bg-white">
                                                    <tr>
                                                        <th>User</th>
                                                        <th>Email</th>
                                                        <th>Action</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <!-- Available users will be listed here -->
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="card h-100">
                                        <div class="card-header">
                                            <h6 class="mb-0">Registered Users</h6>
                                        </div>
                                        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                            <table class="table table-sm table-hover" id="registrations-table">
                                                <thead class="sticky-top bg-white">
                                                    <tr>
                                                        <th>User</th>
                                                        <th>Status</th>
                                                        <th>Action</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <!-- Registered users will be listed here -->
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Navigation buttons -->
                    <div class="d-flex justify-content-between mt-4">
                        <button type="button" class="btn btn-secondary" id="refresh-step"><i class="bi bi-arrow-clockwise"></i> Restart</button>
                        <button type="button" class="btn btn-primary" id="next-step">Next</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block style %}
<link rel="stylesheet" href="/assets/exampro/css/exam-builder.css">
<style>
    /* Force override Bootstrap nav pill styling */
    .nav-pills .nav-link.active, 
    .nav-pills .show > .nav-link {
        background-color: transparent !important;
    }
    
    /* Additional specificity to ensure our styles take precedence */
    .step-navigation.nav-pills .nav-link.active,
    body .step-navigation .nav-link.active {
        background-color: transparent !important;
        color: #007bff;
    }

    /* Category selection styles */
    .category-section {
        border-bottom: 1px solid #e9ecef;
        padding-bottom: 1rem;
    }

    .category-title {
        font-weight: 600;
        margin-bottom: 0.5rem;
        border-left: 3px solid #007bff;
        padding-left: 0.5rem;
    }

    .category-item {
        transition: all 0.2s;
        border: 1px solid #e9ecef;
    }

    .category-item:hover {
        border-color: #007bff;
        box-shadow: 0 2px 4px rgba(0,123,255,0.1);
    }

    .selected-category-item {
        border-left: 3px solid #28a745;
    }

    #selection-summary {
        font-size: 0.875rem;
    }

    .available-categories-container,
    .selected-categories-container {
        background-color: #f8f9fa;
    }

    .modal-body p {
        margin-bottom: 0.5rem;
    }

    .badge {
        margin-right: 0.25rem;
    }
    
    /* Disable all step navigation */
    .nav-link {
        pointer-events: none;
        cursor: default;
    }
    
    /* Keep visual styling for current step */
    .nav-link.active {
        opacity: 1;
    }
    
    /* Style for non-active steps */
    .nav-link:not(.active) {
        opacity: 0.6;
    }
    
    /* Disable previous steps styling */
    .nav-link.disabled-step {
        opacity: 0.4;
    }
    
    .nav-link.disabled-step .step-number {
        background-color: #6c757d !important;
        color: white !important;
    }
</style>
{% endblock %}

{% block script %}
<script src="/assets/exampro/js/exam-builder.js"></script>
{% endblock %}
