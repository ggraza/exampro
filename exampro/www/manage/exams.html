{% extends "exampro/templates/exam_base.html" %}

{% block title %}
{{ _('Manage Exams & Schedules') }}
{% endblock %}

{% block head_include %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
<link rel="stylesheet" href="/assets/exampro/css/manage.css">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}

{% block page_content %}
<div class="container">
    <div class="row mb-5">
        <div class="col">
            <h4>üìù Manage Exams & Schedules</h4>
        </div>
    </div>
    
    <!-- Filter, Search and Buttons in a single row -->
    <div class="row mb-4 align-items-center">
        <div class="col-md-3 mb-2 mb-md-0">
            <select id="status-filter" class="form-control rounded">
                <option value="all">All Items</option>
                <option value="published">Published Exams</option>
                <option value="unpublished">Unpublished Exams</option>
                <option value="upcoming">Upcoming Schedules</option>
                <option value="ongoing">Ongoing Schedules</option>
                <option value="completed">Completed Schedules</option>
            </select>
        </div>
        <div class="col-md-5 mb-2 mb-md-0">
            <input type="text" id="item-search" class="form-control rounded" placeholder="Search by title or name...">
        </div>
        <div class="col-md-2">
            <button id="manage-schedules-btn" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#manage-schedule-modal">
                <i class="bi bi-gear me-1"></i> Manage Schedules
            </button>
        </div>

        <div class="col-md-2 text-md-end">
            <div class="btn-group">
                <button type="button" class="btn btn-primary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-plus-circle me-1"></i> New
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li><a class="dropdown-item" href="/app/exam/new-exam">New Exam</a></li>
                    <li><a class="dropdown-item" href="/app/exam-schedule/new-exam-schedule">New Schedule</a></li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Main content area for exam cards -->
    <div class="row" id="exam-cards-container">
        {% if not exams %}
        <div class="col-12">
            <div class="alert alert-info">
                {{ _("No exams found") }}
            </div>
        </div>
        {% endif %}

        {% for exam in exams %}
        <div class="col-md-4 mb-4 exam-card-wrapper" 
             data-exam-name="{{ exam.name }}" 
             data-exam-title="{{ exam.title }}" 
             data-exam-published="{{ exam.published }}">
            <div class="card exam-card h-100 clickable">
                <div class="card-body">
                    <h5 class="card-title">{{ exam.title }}</h5>
                    <p class="card-text text-muted">
                        {% if exam.description %}
                            {{ exam.description[:100] }}{% if exam.description|length > 100 %}...{% endif %}
                        {% else %}
                            No description available
                        {% endif %}
                    </p>
                    <div class="mt-2">
                        <small class="text-muted"><i class="bi bi-clock"></i> {{ exam.duration }} mins</small>
                    </div>
                    <div>
                        <small class="text-muted"><i class="bi bi-card-list"></i> {{ exam.total_questions }} questions</small>
                    </div>
                    <div>
                        <small class="text-muted"><i class="bi bi-calendar-event"></i> {{ exam.schedules|length }} schedules</small>
                    </div>
                     <div class="mt-2">
                        {% if exam.published %}
                            <span class="badge bg-success text-white">Published</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    <div class="card-footer">
        <div class="row">
            <div class="col">
                <span id="item-count"></span>
            </div>
        </div>
    </div>
</div>

<!-- Manage Schedule Modal -->
<div class="modal fade" id="manage-schedule-modal" tabindex="-1" role="dialog" aria-labelledby="manage-schedule-modal-label" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="manage-schedule-modal-label">Manage Upcoming Schedules</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="schedule-selector" class="form-label">Select Schedule</label>
                    <select id="schedule-selector" class="form-control">
                        <option value="">-- Select a Schedule --</option>
                        <!-- Schedules will be loaded here -->
                    </select>
                </div>
                
                <div id="schedule-management-content" style="display: none;">
                    <ul class="nav nav-tabs" id="manage-schedule-tabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="assign-users-tab" data-bs-toggle="tab" data-bs-target="#assign-users-content" type="button" role="tab">
                                Assign Users
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="evaluators-tab" data-bs-toggle="tab" data-bs-target="#evaluators-content" type="button" role="tab">
                                Evaluators
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="assigned-users-tab" data-bs-toggle="tab" data-bs-target="#assigned-users-content" type="button" role="tab">
                                Current Users
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="batch-assign-tab" data-bs-toggle="tab" data-bs-target="#batch-assign-content" type="button" role="tab">
                                Batch Assign
                            </button>
                        </li>
                    </ul>
                <div class="tab-content mt-3" id="schedule-management-tabs">
                    <div class="tab-pane fade show active" id="assign-users-content" role="tabpanel">
                        <div class="mb-3">
                            <label for="user-search" class="form-label">Search Users</label>
                            <input type="text" class="form-control" id="user-search" placeholder="Search by name or email">
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th><input type="checkbox" id="select-all-users"></th>
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="users-list">
                                    <!-- Users will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                        <div class="d-flex justify-content-end mt-3">
                            <button class="btn btn-primary" id="assign-selected-users">
                                <i class="bi bi-person-plus me-1"></i> Assign Selected
                            </button>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="evaluators-content" role="tabpanel">
                        <div class="mb-3">
                            <label for="evaluator-search" class="form-label">Search Evaluators</label>
                            <input type="text" class="form-control" id="evaluator-search" placeholder="Search by name or email">
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th><input type="checkbox" id="select-all-evaluators"></th>
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th>Role</th>
                                    </tr>
                                </thead>
                                <tbody id="evaluators-list">
                                    <!-- Evaluators will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                        <div class="d-flex justify-content-end mt-3">
                            <button class="btn btn-primary" id="assign-selected-evaluators">
                                <i class="bi bi-person-check me-1"></i> Assign Evaluators
                            </button>
                        </div>
                    </div>
                    
                    <!-- Current Assigned Users Tab -->
                    <div class="tab-pane fade" id="assigned-users-content" role="tabpanel">
                        <div class="mb-3">
                            <h5>Currently Assigned Users</h5>
                            <p class="text-muted">Users currently registered for this exam schedule.</p>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>User</th>
                                        <th>Email</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="assigned-users-list">
                                    <tr id="loading-assigned-users">
                                        <td colspan="4" class="text-center">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="sr-only">Loading...</span>
                                            </div>
                                        </td>
                                    </tr>
                                    <!-- Assigned users will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Batch Assign Tab -->
                    <div class="tab-pane fade" id="batch-assign-content" role="tabpanel">
                        <div class="mb-3">
                            <h5>Batch Assign Users</h5>
                            <p class="text-muted">Assign multiple users at once by selecting a batch.</p>
                        </div>
                        
                        <div class="mb-3">
                            <label for="batch-selector" class="form-label">Select Batch</label>
                            <select id="batch-selector" class="form-control">
                                <option value="">-- Select a Batch --</option>
                                <!-- Batches will be loaded here -->
                            </select>
                        </div>
                        
                        <div id="batch-users-container" style="display: none;">
                            <div class="mb-3">
                                <h6>Users in Selected Batch</h6>
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th><input type="checkbox" id="select-all-batch-users"></th>
                                                <th>Name</th>
                                                <th>Email</th>
                                                <th>Status</th>
                                            </tr>
                                        </thead>
                                        <tbody id="batch-users-list">
                                            <!-- Batch users will be loaded here -->
                                        </tbody>
                                    </table>
                                </div>
                                <div class="d-flex justify-content-end mt-3">
                                    <button class="btn btn-primary" id="assign-selected-batch-users">
                                        <i class="bi bi-person-plus me-1"></i> Assign Selected Users from Batch
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Schedules Modal -->
<div class="modal fade" id="schedules-modal" tabindex="-1" role="dialog" aria-labelledby="schedules-modal-label" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="schedules-modal-label">Schedules</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <ul class="nav nav-tabs" id="modal-tabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="schedules-tab" data-bs-toggle="tab" data-bs-target="#schedules-content" type="button" role="tab">
                    Schedules
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="new-schedule-tab" data-bs-toggle="tab" data-bs-target="#new-schedule-content" type="button" role="tab">
                    New Schedule
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings-content" type="button" role="tab">
                    Exam Settings
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="questions-tab" data-bs-toggle="tab" data-bs-target="#questions-content" type="button" role="tab">
                    Questions
                </button>
            </li>
        </ul>
        <div class="tab-content mt-3">
            <div class="tab-pane fade show active" id="schedules-content" role="tabpanel">
                <div id="schedules-list"></div>
            </div>
            <div class="tab-pane fade" id="new-schedule-content" role="tabpanel">
                <form id="new-schedule-form">
                    <input type="hidden" id="new-schedule-exam-name">
                    <div class="form-group">
                        <label for="new-schedule-name">Schedule Name</label>
                        <input type="text" id="new-schedule-name" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="new-schedule-start-datetime">Start Date & Time</label>
                        <input type="datetime-local" id="new-schedule-start-datetime" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="new-schedule-type">Schedule Type</label>
                        <select id="new-schedule-type" class="form-control">
                            <option value="Fixed">Fixed</option>
                            <option value="Flexible">Flexible</option>
                        </select>
                    </div>
                    <div class="form-group" id="expire-days-container" style="display: none;">
                        <label for="new-schedule-expire-days">Schedule Expire in Days</label>
                        <input type="number" id="new-schedule-expire-days" class="form-control" min="1">
                    </div>
                    <button type="submit" class="btn btn-primary mt-3">Save Schedule</button>
                </form>
            </div>
            <div class="tab-pane fade" id="settings-content" role="tabpanel">
                <div id="exam-actions"></div>
            </div>
            <div class="tab-pane fade" id="questions-content" role="tabpanel">
                <div class="mb-3">
                    <h5>Questions by Category</h5>
                    <p class="text-muted">Select how many questions to include from each category. Categories may appear multiple times if they have questions with different mark values.</p>
                </div>
                <div class="table-responsive">
                    <table class="table table-bordered" id="questions-category-table">
                        <thead>
                            <tr>
                                <th>Category</th>
                                <th>Available Questions</th>
                                <th>Marks per Question</th>
                                <th>Select # of Questions</th>
                            </tr>
                        </thead>
                        <tbody id="questions-categories-body">
                            <!-- Categories will be populated here -->
                            <tr id="loading-categories">
                                <td colspan="4" class="text-center">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="sr-only">Loading...</span>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="d-flex justify-content-between mt-3">
                    <div>
                        <div class="mb-2">
                            <span class="text-muted">Total Questions Selected: <span id="total-questions-selected">0</span></span>
                        </div>
                        <div>
                            <span class="text-muted">Total Marks: <span id="total-marks-calculated">0</span></span>
                        </div>
                    </div>
                    <div>
                        <button type="button" class="btn btn-primary" id="save-questions-config">
                            <i class="bi bi-save me-1"></i> Save Questions Configuration
                        </button>
                    </div>
                </div>
            </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<style>
.exam-card.clickable {
    cursor: pointer;
    transition: all 0.2s ease-in-out;
}
.exam-card.clickable:hover {
    transform: translateY(-5px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}
.loading-spinner {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100px;
}
</style>

<script>
frappe.ready(function() {
    // Global variables to store the current exam and schedule
    var currentExamName = '';
    var currentScheduleName = '';
    
    // Initialize modals using Bootstrap 5
    var manageScheduleModal, schedulesModal;
    
    function initModals() {
        var manageScheduleEl = document.getElementById('manage-schedule-modal');
        var schedulesEl = document.getElementById('schedules-modal');
        
        if (manageScheduleEl) {
            manageScheduleModal = new bootstrap.Modal(manageScheduleEl);
        }
        
        if (schedulesEl) {
            schedulesModal = new bootstrap.Modal(schedulesEl);
        }
    }
    
    // Initialize modals on page load
    initModals();
    
    function applyFilters() {
        var searchTerm = $("#item-search").val().toLowerCase();
        var statusFilter = $("#status-filter").val();

        $(".exam-card-wrapper").each(function() {
            var $cardWrapper = $(this);
            var examTitle = $cardWrapper.data('exam-title').toLowerCase();
            var isPublished = $cardWrapper.data('exam-published');
            
            var examMatchesSearch = !searchTerm || examTitle.indexOf(searchTerm) > -1;
            
            var examMatchesStatus = (statusFilter === 'all') ||
                                    (statusFilter === 'published' && isPublished) ||
                                    (statusFilter === 'unpublished' && !isPublished);

            var showBecauseExamMatches = examMatchesSearch && examMatchesStatus && !['upcoming', 'ongoing', 'completed'].includes(statusFilter);

            if (showBecauseExamMatches) {
                $cardWrapper.show();
            } else {
                $cardWrapper.hide();
            }
        });

        updateItemCount();
    }

    function updateItemCount() {
        var visibleExams = $(".exam-card-wrapper:visible").length;
        $("#item-count").text(`Showing: ${visibleExams} exams`);
    }

    // Add click handler for exam cards
    $(document).on('click', '.exam-card-wrapper', function() {
        var $card = $(this);
        var examName = $card.data('exam-name');
        var examTitle = $card.data('exam-title');
        
        // Set current exam name
        currentExamName = examName;
        
        // Show the modal
        if (schedulesModal) {
            schedulesModal.show();
            
            // Setup modal content
            var modal = $('#schedules-modal');
            modal.find('.modal-title').text('Manage: ' + examTitle);
            
            // Setup New Schedule Tab
            $('#new-schedule-exam-name').val(examName);
            
            // Fetch schedules
            fetchAndPopulateSchedules(examName, modal);
        } else {
            console.error("Schedules Modal not initialized");
        }
    });
    
    // Function to set up the schedules modal
    function setupSchedulesModal(examName, examTitle) {
        
        // Store the exam name in the global variable for use across tabs
        currentExamName = examName;

        var modal = $(this);
        modal.find('.modal-title').text('Manage: ' + examTitle);

        // Setup Settings Tab
        // modal.find('#exam-actions').html(`
        //     <h5>Exam Actions</h5>
        //     <div class="btn-group">
        //         <a href="/app/exam/${examName}" class="btn btn-sm btn-outline-primary">Edit Exam</a>
        //         <button type="button" class="btn btn-sm btn-outline-secondary duplicate-exam" data-exam="${examName}">Duplicate Exam</button>
        //         <button type="button" class="btn btn-sm btn-outline-danger delete-exam" data-exam="${examName}" data-title="${examTitle}">Delete Exam</button>
        //     </div>
        // `);

        // Setup New Schedule Tab
        $('#new-schedule-exam-name').val(examName);

        // Fetch and populate schedules when the tab is shown
        $('a[data-toggle="tab"][href="#schedules-content"]').on('shown.bs.tab', function (e) {
            fetchAndPopulateSchedules(examName, modal);
        });

        // Trigger initial fetch if the tab is already active
        if ($('#schedules-tab').hasClass('active')) {
            fetchAndPopulateSchedules(examName, modal);
        }
        
        // Pre-fetch exam details for questions tab
        if ($('#questions-tab').hasClass('active')) {
            fetchQuestionCategories(examName);
        }
    }

    function fetchAndPopulateSchedules(examName, modal) {
        var $schedulesList = modal.find('#schedules-list');
        $schedulesList.html(`<div class="loading-spinner"><div class="spinner-border text-primary" role="status"><span class="sr-only">Loading...</span></div></div>`);

        frappe.call({
            method: 'exampro.www.manage.exams.get_schedules_for_exam',
            args: { exam: examName },
            callback: function(r) {
                $schedulesList.html(''); // Clear spinner
                if (r.message && r.message.length > 0) {
                    var schedules = r.message;
                    var table = $('<table class="table table-hover"></table>');
                    table.append('<thead><tr><th>Schedule Name</th><th>Start Time</th><th>Status</th><th>Registered Users</th></tr></thead>');
                    var tbody = $('<tbody></tbody>');
                    schedules.forEach(function(sched) {
                        var row = $('<tr></tr>');
                        row.append('<td>' + sched.name + '</td>');
                        row.append('<td>' + (sched.start_date_time ? frappe.datetime.str_to_user(sched.start_date_time) : '-') + '</td>');
                        row.append('<td><span class="badge ' + get_status_badge(sched.status) + '">' + sched.status + '</span></td>');
                        row.append('<td class="text-center">' + sched.registered_users + '</td>');
                        tbody.append(row);
                    });
                    table.append(tbody);
                    $schedulesList.append(table);
                } else {
                    $schedulesList.html('<div class="alert alert-info">No schedules for this exam.</div>');
                }
            },
            error: function(r) {
                $schedulesList.html('<div class="alert alert-danger">Error fetching schedules. Please try again.</div>');
                console.error(r);
            }
        });
    }

    $('#new-schedule-type').on('change', function() {
        if ($(this).val() === 'Flexible') {
            $('#expire-days-container').show();
        } else {
            $('#expire-days-container').hide();
        }
    });

    $('#new-schedule-form').on('submit', function(e) {
        e.preventDefault();
        var examName = $('#new-schedule-exam-name').val();
        var scheduleName = $('#new-schedule-name').val();
        var startDateTime = $('#new-schedule-start-datetime').val();
        var scheduleType = $('#new-schedule-type').val();
        var expireDays = $('#new-schedule-expire-days').val();

        frappe.call({
            method: 'exampro.www.manage.exams.create_schedule',
            args: {
                exam: examName,
                name: scheduleName,
                start_date_time: startDateTime,
                schedule_type: scheduleType,
                schedule_expire_in_days: expireDays
            },
            callback: function(r) {
                if (r.message && r.message.success) {
                    frappe.show_alert({ message: 'Schedule created successfully', indicator: 'green' }, 5);
                    $('#schedules-modal').modal('hide');
                    location.reload();
                } else {
                    frappe.show_alert({ message: r.message.error || 'Error creating schedule', indicator: 'red' }, 5);
                }
            }
        });
    });

    // Add a tab event handler for the questions tab using Bootstrap 5 syntax
    $(document).on('shown.bs.tab', '#questions-tab', function (e) {
        // Use the global currentExamName variable instead of getting it from the hidden input
        if (currentExamName) {
            fetchQuestionCategories(currentExamName);
        } else {
            console.error("No exam selected");
            $('#questions-categories-body').find('tr:not(#loading-categories)').remove();
            $('#loading-categories').hide();
            $('#questions-categories-body').append(`
                <tr>
                    <td colspan="4" class="text-center text-danger">Error: No exam selected</td>
                </tr>
            `);
        }
    });
    
    // Function to fetch question categories for the selected exam
    function fetchQuestionCategories(examName) {
        var $categoriesBody = $('#questions-categories-body');
        
        // Clear previous content except the loading row
        $categoriesBody.find('tr:not(#loading-categories)').remove();
        $('#loading-categories').show();
        
        frappe.call({
            method: 'exampro.www.manage.exams.get_question_categories',
            args: { exam: examName },
            callback: function(r) {
                $('#loading-categories').hide();
                
                if (r.message && r.message.categories) {
                    // Check if the API call was successful
                    if (r.message.success === false) {
                        var errorMessage = r.message.error || 'Error loading question categories';
                        $categoriesBody.append(`
                            <tr>
                                <td colspan="4" class="text-center text-danger">${errorMessage}</td>
                            </tr>
                        `);
                        console.error("API Error:", r.message.error);
                        return;
                    }
                    
                    var categories = r.message.categories;
                    var examConfig = r.message.exam_config || {};
                    
                    if (categories && categories.length > 0) {
                        categories.forEach(function(category) {
                            // Validate that the category has a proper ID
                            if (!category.id) {
                                return; // Skip this category
                            }
                            
                            // Use the composite key to look up the current count
                            var currentCount = examConfig[category.id] || 0;
                            var questionCount = parseInt(category.question_count) || 0;
                            var rowClass = questionCount === 0 ? 'table-warning' : '';
                            
                            var row = $(`
                                <tr data-category-id="${category.id}" class="${rowClass}">
                                    <td>${category.category_name}</td>
                                    <td>
                                        ${questionCount > 0 ? questionCount : 
                                        '<span class="text-warning"><i class="bi bi-exclamation-triangle-fill"></i> No questions</span>'}
                                    </td>
                                    <td>${category.marks_per_question || 1}</td>
                                    <td>
                                        <input type="number" class="form-control category-question-count" 
                                            min="0" max="${questionCount}" value="${currentCount}" 
                                            data-category="${category.id}" data-max="${questionCount}"
                                            ${questionCount === 0 ? 'disabled' : ''}>
                                        ${questionCount === 0 ? 
                                        '<small class="text-muted">Add questions to this category first</small>' : ''}
                                    </td>
                                </tr>
                            `);
                            $categoriesBody.append(row);
                        });
                        
                        updateTotalQuestions();
                        
                        // Add event listeners to update total when input changes
                        $('.category-question-count').on('input', function() {
                            var max = parseInt($(this).data('max'));
                            var val = parseInt($(this).val()) || 0;
                            
                            // Enforce min/max constraints
                            if (val < 0) $(this).val(0);
                            if (val > max) $(this).val(max);
                            
                            updateTotalQuestions();
                        });
                    } else {
                        $categoriesBody.append(`
                            <tr>
                                <td colspan="4" class="text-center">No question categories found.</td>
                            </tr>
                        `);
                    }
                } else {
                    // Handle case where categories doesn't exist in the response
                    var errorMessage = (r.message && r.message.error) ? r.message.error : 'Error loading question categories.';
                    $categoriesBody.append(`
                        <tr>
                            <td colspan="4" class="text-center text-danger">${errorMessage}</td>
                        </tr>
                    `);
                    console.error("API Response missing categories:", r.message);
                }
            },
            error: function(r) {
                $('#loading-categories').hide();
                var errorMessage = 'Network or server error loading question categories.';
                if (r && r.responseJSON && r.responseJSON.exception) {
                    errorMessage = r.responseJSON.exception;
                }
                
                $categoriesBody.append(`
                    <tr>
                        <td colspan="4" class="text-center text-danger">${errorMessage}</td>
                    </tr>
                `);
                console.error("AJAX Error:", r);
            }
        });
    }
    
    // Function to update the total questions count and marks
    function updateTotalQuestions() {
        var totalQuestions = 0;
        var totalMarks = 0;
        
        $('.category-question-count').each(function() {
            var count = parseInt($(this).val()) || 0;
            var marksPerQuestion = parseInt($(this).closest('tr').find('td:eq(2)').text()) || 1;
            
            totalQuestions += count;
            totalMarks += (count * marksPerQuestion);
        });
        
        $('#total-questions-selected').text(totalQuestions);
        $('#total-marks-calculated').text(totalMarks);
    }
    
    // Handle saving the questions configuration
    $('#save-questions-config').on('click', function() {
        // Use the global variable for consistency
        var examName = currentExamName;
        if (!examName) {
            frappe.show_alert({ message: 'Error: No exam selected', indicator: 'red' }, 5);
            return;
        }
        var categoryConfig = {};
        
        $('.category-question-count').each(function() {
            var category = $(this).data('category');
            var count = parseInt($(this).val()) || 0;
            categoryConfig[category] = count;
        });
        
        // Save button state
        var $btn = $(this);
        var originalText = $btn.html();
        $btn.html('<i class="bi bi-hourglass-split me-1"></i> Saving...').prop('disabled', true);
        
        frappe.call({
            method: 'exampro.www.manage.exams.update_exam_questions',
            args: {
                exam: examName,
                category_config: categoryConfig
            },
            callback: function(r) {
                $btn.html(originalText).prop('disabled', false);
                
                if (r.message && r.message.success) {
                    frappe.show_alert({ message: 'Question configuration saved successfully', indicator: 'green' }, 3);
                    
                    // Update question count and marks in the card
                    var totalQuestions = r.message.total_questions || $('#total-questions-selected').text();
                    $(`.exam-card-wrapper[data-exam-name="${examName}"] small:contains("questions")`).html(`<i class="bi bi-card-list"></i> ${totalQuestions} questions`);
                } else {
                    frappe.show_alert({ message: r.message.error || 'Error saving question configuration', indicator: 'red' }, 5);
                }
            },
            error: function(r) {
                $btn.html(originalText).prop('disabled', false);
                frappe.show_alert({ message: 'Error saving question configuration', indicator: 'red' }, 5);
                console.error(r);
            }
        });
    });

    function get_status_badge(status) {
        switch(status) {
            case 'Upcoming': return 'bg-info text-white';
            case 'Ongoing': return 'bg-warning text-white';
            case 'Completed': return 'bg-success text-white';
            default: return 'bg-secondary text-white';
        }
    }

    // Add click handler for the manage schedules button
    $('#manage-schedules-btn').on('click', function() {
        if (manageScheduleModal) {
            manageScheduleModal.show();
        } else {
            console.error("Manage Schedule Modal not initialized");
        }
    });
    
    // Handle the manage schedule modal opening
    $('#manage-schedule-modal').on('show.bs.modal', function(event) {
        // Clear the schedule selector and hide the content
        $('#schedule-selector').html('<option value="">-- Select a Schedule --</option>');
        $('#schedule-management-content').hide();
        
        // Load all available schedules from all exams
        loadAllSchedules();
    });
    
    // Function to load all schedules for the dropdown
    function loadAllSchedules() {
        $('#schedule-selector').prop('disabled', true);
        
        frappe.call({
            method: 'exampro.www.manage.exams.get_all_schedules',
            callback: function(r) {
                $('#schedule-selector').prop('disabled', false);
                
                if (r.message && r.message.schedules) {
                    var schedules = r.message.schedules;
                    
                    if (schedules.length > 0) {
                        schedules.forEach(function(schedule) {
                            var formattedDate = schedule.start_date_time ? 
                                frappe.datetime.str_to_user(schedule.start_date_time) : 
                                'No date';
                                
                            $('#schedule-selector').append(`
                                <option value="${schedule.name}" data-exam="${schedule.exam}">
                                    ${schedule.name} - ${schedule.exam_title} (${formattedDate})
                                </option>
                            `);
                        });
                    } else {
                        $('#schedule-selector').append('<option value="" disabled>No schedules available</option>');
                    }
                } else {
                    $('#schedule-selector').append('<option value="" disabled>Error loading schedules</option>');
                }
            },
            error: function() {
                $('#schedule-selector').prop('disabled', false);
                $('#schedule-selector').append('<option value="" disabled>Error loading schedules</option>');
            }
        });
    }
    
    // Handle schedule selection
    $('#schedule-selector').on('change', function() {
        var selectedSchedule = $(this).val();
        
        if (selectedSchedule) {
            $('#schedule-management-content').show();
            loadScheduleData(selectedSchedule);
        } else {
            $('#schedule-management-content').hide();
        }
    });
    
    // Function to load schedule data
    function loadScheduleData(scheduleName) {
        // Load assigned users when tab is shown
        loadAssignedUsers(scheduleName);
        
        // Load available batches
        loadAvailableBatches();
        
        // Set the current schedule for other functions
        currentScheduleName = scheduleName;
    }
    
    // Function to load assigned users for a schedule
    function loadAssignedUsers(scheduleName) {
        var $assignedUsersList = $('#assigned-users-list');
        $('#loading-assigned-users').show();
        $assignedUsersList.find('tr:not(#loading-assigned-users)').remove();
        
        frappe.call({
            method: 'exampro.www.manage.exams.get_assigned_users',
            args: { schedule: scheduleName },
            callback: function(r) {
                $('#loading-assigned-users').hide();
                
                if (r.message && r.message.users) {
                    var users = r.message.users;
                    
                    if (users.length > 0) {
                        users.forEach(function(user) {
                            var statusBadgeClass = '';
                            switch(user.status) {
                                case 'Not Started': statusBadgeClass = 'bg-secondary'; break;
                                case 'In Progress': statusBadgeClass = 'bg-warning'; break;
                                case 'Completed': statusBadgeClass = 'bg-success'; break;
                                case 'Evaluated': statusBadgeClass = 'bg-info'; break;
                                default: statusBadgeClass = 'bg-secondary';
                            }
                            
                            $assignedUsersList.append(`
                                <tr data-user="${user.user}">
                                    <td>${user.user_name || user.user}</td>
                                    <td>${user.email || 'N/A'}</td>
                                    <td><span class="badge ${statusBadgeClass}">${user.status}</span></td>
                                    <td>
                                        <button class="btn btn-sm btn-danger remove-user" data-user="${user.user}">
                                            <i class="bi bi-trash"></i> Remove
                                        </button>
                                    </td>
                                </tr>
                            `);
                        });
                    } else {
                        $assignedUsersList.append(`
                            <tr>
                                <td colspan="4" class="text-center">No users assigned to this schedule.</td>
                            </tr>
                        `);
                    }
                } else {
                    $assignedUsersList.append(`
                        <tr>
                            <td colspan="4" class="text-center text-danger">
                                Error loading assigned users. ${r.message && r.message.error ? r.message.error : ''}
                            </td>
                        </tr>
                    `);
                }
            },
            error: function() {
                $('#loading-assigned-users').hide();
                $assignedUsersList.append(`
                    <tr>
                        <td colspan="4" class="text-center text-danger">Network or server error loading assigned users.</td>
                    </tr>
                `);
            }
        });
    }
    
    // Function to load available batches
    function loadAvailableBatches() {
        var $batchSelector = $('#batch-selector');
        $batchSelector.html('<option value="">-- Select a Batch --</option>');
        $batchSelector.prop('disabled', true);
        
        frappe.call({
            method: 'exampro.www.manage.exams.get_available_batches',
            callback: function(r) {
                $batchSelector.prop('disabled', false);
                
                if (r.message && r.message.batches) {
                    var batches = r.message.batches;
                    
                    if (batches.length > 0) {
                        batches.forEach(function(batch) {
                            $batchSelector.append(`
                                <option value="${batch.name}">${batch.name} (${batch.user_count} users)</option>
                            `);
                        });
                    } else {
                        $batchSelector.append('<option value="" disabled>No batches available</option>');
                    }
                } else {
                    $batchSelector.append('<option value="" disabled>Error loading batches</option>');
                }
            },
            error: function() {
                $batchSelector.prop('disabled', false);
                $batchSelector.append('<option value="" disabled>Error loading batches</option>');
            }
        });
    }
    
    // Handle batch selection
    $('#batch-selector').on('change', function() {
        var selectedBatch = $(this).val();
        
        if (selectedBatch) {
            loadBatchUsers(selectedBatch);
            $('#batch-users-container').show();
        } else {
            $('#batch-users-container').hide();
        }
    });
    
    // Function to load users from a batch
    function loadBatchUsers(batchName) {
        var $batchUsersList = $('#batch-users-list');
        $batchUsersList.html(`
            <tr>
                <td colspan="4" class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="sr-only">Loading...</span>
                    </div>
                </td>
            </tr>
        `);
        
        frappe.call({
            method: 'exampro.www.manage.exams.get_batch_users',
            args: { batch: batchName, schedule: currentScheduleName },
            callback: function(r) {
                $batchUsersList.empty();
                
                if (r.message && r.message.users) {
                    var users = r.message.users;
                    
                    if (users.length > 0) {
                        users.forEach(function(user) {
                            var disabledAttr = user.already_assigned ? 'disabled' : '';
                            var statusText = user.already_assigned ? 'Already Assigned' : 'Not Assigned';
                            var statusClass = user.already_assigned ? 'text-success' : 'text-muted';
                            
                            $batchUsersList.append(`
                                <tr data-user="${user.user}">
                                    <td>
                                        <input type="checkbox" class="batch-user-checkbox" 
                                            value="${user.user}" ${disabledAttr}>
                                    </td>
                                    <td>${user.user_name || user.user}</td>
                                    <td>${user.email || 'N/A'}</td>
                                    <td class="${statusClass}">${statusText}</td>
                                </tr>
                            `);
                        });
                    } else {
                        $batchUsersList.append(`
                            <tr>
                                <td colspan="4" class="text-center">No users in this batch.</td>
                            </tr>
                        `);
                    }
                } else {
                    $batchUsersList.append(`
                        <tr>
                            <td colspan="4" class="text-center text-danger">
                                Error loading batch users. ${r.message && r.message.error ? r.message.error : ''}
                            </td>
                        </tr>
                    `);
                }
            },
            error: function() {
                $batchUsersList.empty();
                $batchUsersList.append(`
                    <tr>
                        <td colspan="4" class="text-center text-danger">Network or server error loading batch users.</td>
                    </tr>
                `);
            }
        });
    }
    
    // Handle select all batch users checkbox
    $('#select-all-batch-users').on('change', function() {
        var isChecked = $(this).prop('checked');
        $('.batch-user-checkbox:not(:disabled)').prop('checked', isChecked);
    });
    
    // Handle batch user assign button
    $('#assign-selected-batch-users').on('click', function() {
        var selectedUsers = [];
        $('.batch-user-checkbox:checked').each(function() {
            selectedUsers.push($(this).val());
        });
        
        if (selectedUsers.length === 0) {
            frappe.show_alert({ message: 'Please select users to assign', indicator: 'red' }, 3);
            return;
        }
        
        // Save button state
        var $btn = $(this);
        var originalText = $btn.html();
        $btn.html('<i class="bi bi-hourglass-split me-1"></i> Assigning...').prop('disabled', true);
        
        frappe.call({
            method: 'exampro.www.manage.exams.assign_users_to_schedule',
            args: {
                schedule: currentScheduleName,
                users: selectedUsers
            },
            callback: function(r) {
                $btn.html(originalText).prop('disabled', false);
                
                if (r.message && r.message.success) {
                    frappe.show_alert({ message: `Successfully assigned ${r.message.assigned_count} users to the schedule`, indicator: 'green' }, 3);
                    
                    // Refresh the batch users list
                    var currentBatch = $('#batch-selector').val();
                    if (currentBatch) {
                        loadBatchUsers(currentBatch);
                    }
                    
                    // Refresh the assigned users list
                    loadAssignedUsers(currentScheduleName);
                } else {
                    frappe.show_alert({ message: r.message && r.message.error ? r.message.error : 'Error assigning users', indicator: 'red' }, 5);
                }
            },
            error: function() {
                $btn.html(originalText).prop('disabled', false);
                frappe.show_alert({ message: 'Network or server error while assigning users', indicator: 'red' }, 5);
            }
        });
    });
    
    // Handle user removal
    $(document).on('click', '.remove-user', function() {
        var user = $(this).data('user');
        var $btn = $(this);
        
        frappe.confirm(`Are you sure you want to remove ${user} from this schedule?`, function() {
            $btn.html('<i class="bi bi-hourglass-split"></i>').prop('disabled', true);
            
            frappe.call({
                method: 'exampro.www.manage.exams.remove_user_from_schedule',
                args: {
                    schedule: currentScheduleName,
                    user: user
                },
                callback: function(r) {
                    if (r.message && r.message.success) {
                        frappe.show_alert({ message: 'User removed from schedule', indicator: 'green' }, 3);
                        loadAssignedUsers(currentScheduleName);
                    } else {
                        $btn.html('<i class="bi bi-trash"></i> Remove').prop('disabled', false);
                        frappe.show_alert({ message: r.message && r.message.error ? r.message.error : 'Error removing user', indicator: 'red' }, 5);
                    }
                },
                error: function() {
                    $btn.html('<i class="bi bi-trash"></i> Remove').prop('disabled', false);
                    frappe.show_alert({ message: 'Network or server error while removing user', indicator: 'red' }, 5);
                }
            });
        });
    });
    
    // Handle tab changes in schedule management
    $('#manage-schedule-tabs button[data-bs-toggle="tab"]').on('shown.bs.tab', function (e) {
        var target = $(e.target).attr('data-bs-target');
        
        if (target === '#assigned-users-content' && currentScheduleName) {
            loadAssignedUsers(currentScheduleName);
        }
    });
    
    // Modal event handlers
    $('#schedules-modal').on('hidden.bs.modal', function () {
        var modal = $(this);
        modal.find('#schedules-list').html('');
        modal.find('#exam-actions').html('');
        $('#new-schedule-form')[0].reset();
        $('#expire-days-container').hide();
        // Clear questions category table
        $('#questions-categories-body tr:not(#loading-categories)').remove();
        $('#total-questions-selected').text('0');
        $('#total-marks-calculated').text('0');
        // Reset tabs to default
        var firstTab = document.querySelector('#modal-tabs button:first-child');
        if (firstTab) {
            var tab = new bootstrap.Tab(firstTab);
            tab.show();
        }
        // Unbind tab show events to prevent multiple triggers
        $('#schedules-tab, #questions-tab').off('shown.bs.tab');
    });
    
    // Handle manage schedule modal reset
    $('#manage-schedule-modal').on('hidden.bs.modal', function() {
        $('#schedule-selector').html('<option value="">-- Select a Schedule --</option>');
        $('#schedule-management-content').hide();
        $('#batch-users-container').hide();
        $('#batch-selector').val('');
        $('#assigned-users-list tr:not(#loading-assigned-users)').remove();
        currentScheduleName = '';
    });

    $("#item-search, #status-filter").on("keyup change", function() {
        applyFilters();
    });

    $(document).on("click", ".duplicate-exam", function() {
        var examName = $(this).data('exam');
        frappe.call({
            method: 'exampro.www.manage.exams.duplicate_exam',
            args: { exam: examName },
            callback: function(r) {
                if (r.message && r.message.success) {
                    frappe.show_alert({ message: 'Exam duplicated successfully', indicator: 'green' }, 3);
                    setTimeout(() => location.reload(), 1000);
                } else {
                    frappe.show_alert({ message: r.message.error || 'Failed to duplicate exam', indicator: 'red' }, 5);
                }
            }
        });
    });

    $(document).on("click", ".delete-exam", function() {
        var examName = $(this).data('exam');
        var examTitle = $(this).data('title');
        frappe.confirm(`Are you sure you want to delete exam "${examTitle}"? This will also delete all associated schedules. This action cannot be undone.`,
            () => {
                frappe.call({
                    method: 'exampro.www.manage.exams.delete_exam',
                    args: { exam: examName },
                    callback: function(r) {
                        if (r.message && r.message.success) {
                            frappe.show_alert({ message: 'Exam deleted successfully', indicator: 'green' }, 3);
                            $('#schedules-modal').modal('hide');
                            $(`.exam-card-wrapper[data-exam-name="${examName}"]`).remove();
                            applyFilters();
                        } else {
                            frappe.show_alert({ message: r.message.error || 'Failed to delete exam', indicator: 'red' }, 5);
                        }
                    }
                });
            }
        );
    });

    applyFilters();
    
    // Initialize Bootstrap modals when DOM is loaded
    $(document).ready(function() {
        try {
            // Initialize Bootstrap modals properly
            var manageScheduleModal = new bootstrap.Modal(document.getElementById('manage-schedule-modal'));
            var schedulesModal = new bootstrap.Modal(document.getElementById('schedules-modal'));
            
            // Add click handler for manage schedules button if data attributes aren't working
            var manageButton = document.querySelector('.btn[data-bs-target="#manage-schedule-modal"]');
            if (manageButton) {
                manageButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    manageScheduleModal.show();
                });
            }
        } catch (err) {
            console.error("Error initializing Bootstrap modals:", err);
        }
    });
    
    // Fix for exam cards if data attributes aren't working (moved inside the main script)
    document.querySelectorAll('.exam-card-wrapper').forEach(function(card) {
        card.addEventListener('click', function(e) {
            e.preventDefault();
            var examName = this.getAttribute('data-exam-name');
            var examTitle = this.getAttribute('data-exam-title');
            
            // Set global variable
            window.currentExamName = examName;
            
            // Update modal content
            document.querySelector('#schedules-modal .modal-title').textContent = 'Manage: ' + examTitle;
            document.getElementById('new-schedule-exam-name').value = examName;
            
            try {
                // Show modal with Bootstrap 5 API
                var schedulesModal = new bootstrap.Modal(document.getElementById('schedules-modal'));
                schedulesModal.show();
            } catch (err) {
                // Fallback to jQuery modal
                console.error("Error showing modal with Bootstrap API, trying jQuery fallback:", err);
                $('#schedules-modal').modal('show');
            }
            
            // Load initial data
            fetchAndPopulateSchedules(examName, $('#schedules-modal'));
        });
    });
});
</script>
{% endblock %}