{% extends "exampro/templates/exam_base.html" %}

{% block title %}
{{ _('Manage Exams & Schedules') }}
{% endblock %}

{% block head_include %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
<link rel="stylesheet" href="/assets/exampro/css/manage.css">
<link rel="stylesheet" href="/assets/exampro/css/exam-builder.css">
{% endblock %}

{% block page_content %}
<div class="container">
    <div class="row mb-5">
        <div class="col">
            <h4>üìù Manage Exams & Schedules</h4>
        </div>
    </div>
    
    <!-- Filter, Search and Buttons in a single row -->
    <div class="row mb-4 align-items-center">
        <div class="col-md-3 mb-2 mb-md-0">
            <select id="status-filter" class="form-control rounded">
                <option value="all">All Items</option>
                <option value="published">Published Exams</option>
                <option value="unpublished">Unpublished Exams</option>
                <option value="upcoming">Upcoming Schedules</option>
                <option value="ongoing">Ongoing Schedules</option>
                <option value="completed">Completed Schedules</option>
            </select>
        </div>
        <div class="col-md-5 mb-2 mb-md-0">
            <input type="text" id="item-search" class="form-control rounded" placeholder="Search by title or name...">
        </div>
        <div class="col-md-4 text-md-end">
            <div class="btn-toolbar justify-content-md-end">
                <a href="/app/exam-schedule/new-exam-schedule" class="btn btn-outline-primary me-2">
                    <i class="bi bi-plus-circle me-1"></i> New Schedule
                </a>
                <a href="/app/exam/new-exam" class="btn btn-primary">
                    <i class="bi bi-plus-circle me-1"></i> New Exam
                </a>
            </div>
        </div>
    </div>

    <!-- Main content area for exam cards -->
    <div class="row" id="exam-cards-container">
        {% if not exams %}
        <div class="col-12">
            <div class="alert alert-info">
                {{ _("No exams found") }}
            </div>
        </div>
        {% endif %}

        {% for exam in exams %}
        <div class="col-md-4 mb-4 exam-card-wrapper" 
             data-exam-name="{{ exam.name }}" 
             data-exam-title="{{ exam.title }}" 
             data-exam-published="{{ exam.published }}"
             data-toggle="modal" 
             data-target="#schedules-modal">
            <div class="card exam-card h-100 clickable">
                <div class="card-body">
                    <h5 class="card-title">{{ exam.title }}</h5>
                    <p class="card-text text-muted">
                        {% if exam.description %}
                            {{ exam.description[:100] }}{% if exam.description|length > 100 %}...{% endif %}
                        {% else %}
                            No description available
                        {% endif %}
                    </p>
                    <div class="mt-2">
                        <small class="text-muted"><i class="bi bi-clock"></i> {{ exam.duration }} mins</small>
                    </div>
                    <div>
                        <small class="text-muted"><i class="bi bi-card-list"></i> {{ exam.total_questions }} questions</small>
                    </div>
                    <div>
                        <small class="text-muted"><i class="bi bi-calendar-event"></i> {{ exam.schedules|length }} schedules</small>
                    </div>
                     <div class="mt-2">
                        {% if exam.published %}
                            <span class="badge bg-success text-white">Published</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    <div class="card-footer">
        <div class="row">
            <div class="col">
                <span id="item-count"></span>
            </div>
        </div>
    </div>
</div>

<!-- Schedules Modal -->
<div class="modal fade" id="schedules-modal" tabindex="-1" role="dialog" aria-labelledby="schedules-modal-label" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="schedules-modal-label">Schedules</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div id="exam-actions" class="mb-3"></div>
        <div id="schedules-list"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<style>
.exam-card.clickable {
    cursor: pointer;
    transition: all 0.2s ease-in-out;
}
.exam-card.clickable:hover {
    transform: translateY(-5px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}
.loading-spinner {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100px;
}
</style>

<script>
frappe.ready(function() {
    function applyFilters() {
        var searchTerm = $("#item-search").val().toLowerCase();
        var statusFilter = $("#status-filter").val();

        $(".exam-card-wrapper").each(function() {
            var $cardWrapper = $(this);
            var examTitle = $cardWrapper.data('exam-title').toLowerCase();
            var isPublished = $cardWrapper.data('exam-published');
            
            var examMatchesSearch = !searchTerm || examTitle.indexOf(searchTerm) > -1;
            
            var examMatchesStatus = (statusFilter === 'all') ||
                                    (statusFilter === 'published' && isPublished) ||
                                    (statusFilter === 'unpublished' && !isPublished);

            var showBecauseExamMatches = examMatchesSearch && examMatchesStatus && !['upcoming', 'ongoing', 'completed'].includes(statusFilter);

            if (showBecauseExamMatches) {
                $cardWrapper.show();
            } else {
                $cardWrapper.hide();
            }
        });

        updateItemCount();
    }

    function updateItemCount() {
        var visibleExams = $(".exam-card-wrapper:visible").length;
        $("#item-count").text(`Showing: ${visibleExams} exams`);
    }

    $('#schedules-modal').on('show.bs.modal', function (event) {
        var card = $(event.relatedTarget);
        var examName = card.data('exam-name');
        var examTitle = card.data('exam-title');

        var modal = $(this);
        modal.find('.modal-title').text('Manage: ' + examTitle);

        // Populate exam actions
        modal.find('#exam-actions').html(`
            <div class="btn-group">
                <a href="/app/exam/${examName}" class="btn btn-sm btn-outline-primary">Edit Exam</a>
                <button type="button" class="btn btn-sm btn-outline-secondary duplicate-exam" data-exam="${examName}">Duplicate Exam</button>
                <button type="button" class="btn btn-sm btn-outline-danger delete-exam" data-exam="${examName}" data-title="${examTitle}">Delete Exam</button>
            </div>
        `);

        // Show loading spinner
        var $schedulesList = modal.find('#schedules-list');
        $schedulesList.html(`<div class="loading-spinner"><div class="spinner-border text-primary" role="status"><span class="sr-only">Loading...</span></div></div>`);

        // Fetch and populate schedules
        frappe.call({
            method: 'exampro.www.manage.exams.get_schedules_for_exam',
            args: { exam: examName },
            callback: function(r) {
                $schedulesList.html(''); // Clear spinner
                if (r.message && r.message.length > 0) {
                    var schedules = r.message;
                    var table = $('<table class="table table-hover"></table>');
                    table.append('<thead><tr><th>Schedule Name</th><th>Start Time</th><th>Status</th><th>Registered Users</th></tr></thead>');
                    var tbody = $('<tbody></tbody>');
                    schedules.forEach(function(sched) {
                        var row = $('<tr></tr>');
                        row.append('<td>' + sched.name + '</td>');
                        row.append('<td>' + (sched.start_date_time ? frappe.datetime.str_to_user(sched.start_date_time) : '-') + '</td>');
                        row.append('<td><span class="badge ' + get_status_badge(sched.status) + '">' + sched.status + '</span></td>');
                        row.append('<td class="text-center">' + sched.registered_users + '</td>');
                        tbody.append(row);
                    });
                    table.append(tbody);
                    $schedulesList.append(table);
                } else {
                    $schedulesList.html('<div class="alert alert-info">No schedules for this exam.</div>');
                }
            },
            error: function(r) {
                $schedulesList.html('<div class="alert alert-danger">Error fetching schedules. Please try again.</div>');
                console.error(r);
            }
        });
    });

    function get_status_badge(status) {
        switch(status) {
            case 'Upcoming': return 'bg-info text-white';
            case 'Ongoing': return 'bg-warning text-white';
            case 'Completed': return 'bg-success text-white';
            default: return 'bg-secondary text-white';
        }
    }

    $('#schedules-modal').on('hidden.bs.modal', function () {
        var modal = $(this);
        modal.find('#schedules-list').html('');
        modal.find('#exam-actions').html('');
    });

    $("#item-search, #status-filter").on("keyup change", function() {
        applyFilters();
    });

    $(document).on("click", ".duplicate-exam", function() {
        var examName = $(this).data('exam');
        frappe.call({
            method: 'exampro.www.manage.exams.duplicate_exam',
            args: { exam: examName },
            callback: function(r) {
                if (r.message && r.message.success) {
                    frappe.show_alert({ message: 'Exam duplicated successfully', indicator: 'green' }, 3);
                    setTimeout(() => location.reload(), 1000);
                } else {
                    frappe.show_alert({ message: r.message.error || 'Failed to duplicate exam', indicator: 'red' }, 5);
                }
            }
        });
    });

    $(document).on("click", ".delete-exam", function() {
        var examName = $(this).data('exam');
        var examTitle = $(this).data('title');
        frappe.confirm(`Are you sure you want to delete exam "${examTitle}"? This will also delete all associated schedules. This action cannot be undone.`,
            () => {
                frappe.call({
                    method: 'exampro.www.manage.exams.delete_exam',
                    args: { exam: examName },
                    callback: function(r) {
                        if (r.message && r.message.success) {
                            frappe.show_alert({ message: 'Exam deleted successfully', indicator: 'green' }, 3);
                            $('#schedules-modal').modal('hide');
                            $(`.exam-card-wrapper[data-exam-name="${examName}"]`).remove();
                            applyFilters();
                        } else {
                            frappe.show_alert({ message: r.message.error || 'Failed to delete exam', indicator: 'red' }, 5);
                        }
                    }
                });
            }
        );
    });

    applyFilters();
});
</script>
{% endblock %}